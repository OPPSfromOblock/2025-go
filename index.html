<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GO 2025 ‚Äî Scoring (With Auth & Roles)</title>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
  :root{
    /* Bright ESPN-style white/red palette */
    --bg:#f3f4f6;
    --bg-alt:#e5e7eb;
    --card:#ffffff;
    --card-alt:#f9fafb;
    --text:#0f172a;
    --accent:#c8102e; /* deep sports red */
    --accent-2:#f97373; /* lighter action red */
    --accent-soft:rgba(200,16,46,0.08);
    --muted:#6b7280;
    --glass:#ffffff;
    --radius:12px;
    --radius-lg:18px;
    --border-subtle:rgba(15,23,42,0.08);
    --shadow-soft:0 18px 40px rgba(15,23,42,0.06);

    --neon-pink:#c8102e;
    --neon-cyan:#f97373;
    --neon-purple:#f97373;
  }

  *{box-sizing:border-box;margin:0;padding:0}
  html,body{scroll-behavior:smooth}
  body{
    margin:0;
    font-family:Inter,system-ui,Arial,sans-serif;
    background:linear-gradient(180deg,#ffffff 0%,#f3f4f6 50%,#e5e7eb 100%);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    min-height:100vh;
    display:flex;
    align-items:stretch;
    overflow-x:hidden;
    overflow-y:auto;
  }

  body::before{
    content:"";
    position:fixed;
    inset:-20%;
    background:radial-gradient(circle at top,#fee2e2 0%,transparent 60%);
    opacity:0.65;
    pointer-events:none;
    z-index:-1;
  }

  @keyframes spinGradient{
    from{transform:rotate(0deg);} to{transform:rotate(360deg);}
  }

  /* Layout */
  .sidebar{
    width:260px;
    padding:20px 18px;
    background:#ffffff !important;
    border-right:1px solid rgba(229,231,235,1);
    display:flex;
    flex-direction:column;
    gap:16px;
    box-shadow:12px 0 30px rgba(15,23,42,0.08);
    color:var(--text);
  }

  /* Dark mode overrides (sidebar + search bar + main UI) */
  body.dark-mode{
    background:#020617;
    color:#f9fafb;
  }
  body.dark-mode::before{
    content:"";
    position:fixed;
    inset:-20%;
    background:radial-gradient(circle at top,#7f1d1d 0%,transparent 60%);
    opacity:0.45;
    pointer-events:none;
    z-index:-1;
  }

  body.dark-mode .sidebar{
    background:#020617 !important;
    color:#f9fafb;
    border-right:1px solid rgba(15,23,42,0.9);
    box-shadow:12px 0 30px rgba(15,23,42,0.9);
  }
  body.dark-mode .sidebar .muted{
    color:#9ca3af;
  }
  body.dark-mode .logo{
    background:#020617;
    color:#fecaca;
    border-color:#ef4444;
    box-shadow:0 8px 18px rgba(0,0,0,0.7);
  }
  body.dark-mode nav button{
    color:#f9fafb;
  }
  body.dark-mode nav button:hover{
    background:rgba(31,41,55,1);
  }
  body.dark-mode nav button.active{
    background:linear-gradient(90deg,rgba(248,113,113,0.35),rgba(15,23,42,1));
    color:#fecaca;
  }

  /* Cards / content */
  body.dark-mode .card{
    background:#020617;
    border-color:rgba(31,41,55,1);
    box-shadow:0 18px 40px rgba(0,0,0,0.7);
    color:#f9fafb;
  }
  body.dark-mode .muted{
    color:#d1d5db;
  }

  /* Headings */
  body.dark-mode h1,
  body.dark-mode h2,
  body.dark-mode h3,
  body.dark-mode h4{
    color:#f9fafb;
  }
  body.dark-mode .quote-card{
    background:#020617;
    border-color:#ef4444;
  }
  body.dark-mode .stat-card{
    background:linear-gradient(135deg,#020617,#111827);
    border-color:rgba(31,41,55,1);
  }

  /* Buttons */
  body.dark-mode .btn{
    background:#111827;
    color:#f9fafb;
    border-color:rgba(55,65,81,1);
  }
  body.dark-mode .btn:hover{
    background:#1f2937;
    box-shadow:0 4px 10px rgba(0,0,0,0.8);
  }
  body.dark-mode .btn.primary{
    color:#fef2f2;
    box-shadow:0 8px 18px rgba(248,113,113,0.8);
  }
  body.dark-mode .btn.ghost{
    background:transparent;
    border:1px solid rgba(75,85,99,1);
    color:#f9fafb;
  }

  /* Inputs & selects */
  body.dark-mode input[type="text"],
  body.dark-mode input[type="email"],
  body.dark-mode select{
    background:#020617;
    color:#f9fafb;
    border-color:rgba(55,65,81,1);
  }
  body.dark-mode input[type="text"]::placeholder,
  body.dark-mode input[type="email"]::placeholder{
    color:#9ca3af;
  }
  body.dark-mode input[type="text"]:focus,
  body.dark-mode input[type="email"]:focus,
  body.dark-mode select:focus{
    background:#020617;
    box-shadow:0 0 0 1px rgba(248,113,113,0.7);
  }
  body.dark-mode .pwbox input{
    background:#020617;
    color:#f9fafb;
    border-color:rgba(55,65,81,1);
  }

  /* Matches / lists */
  body.dark-mode .match-card{
    background:#020617;
    border-color:rgba(31,41,55,1);
    box-shadow:0 10px 24px rgba(0,0,0,0.8);
    color:#f9fafb;
  }
  body.dark-mode .match-card .muted{
    color:#f9fafb;
  }
  body.dark-mode .match-card:hover{
    background:#111827;
  }

  /* Score sheet & modals */
  body.dark-mode #scoreSheet{
    background:#020617;
    border-color:rgba(31,41,55,1);
    box-shadow:0 24px 80px rgba(0,0,0,0.9);
  }
  body.dark-mode .modal{
    background:#020617;
    border-color:rgba(31,41,55,1);
    box-shadow:0 24px 70px rgba(0,0,0,0.9);
  }
  body.dark-mode .pwbox{
    background:#020617;
    border-color:rgba(31,41,55,1);
    box-shadow:0 24px 70px rgba(0,0,0,0.9);
  }

  /* Logs / team blocks */
  body.dark-mode .teamBlock{
    background:#020617;
    border-color:rgba(31,41,55,1);
  }
  body.dark-mode .log{
    background:#020617;
    border-color:rgba(31,41,55,1);
    color:#e5e7eb;
  }

  /* Pagination buttons */
  body.dark-mode .pagination button{
    background:#020617;
    border-color:rgba(55,65,81,1);
    color:#e5e7eb;
  }
  body.dark-mode .pagination button:hover{
    background:#111827;
    color:#fef2f2;
    box-shadow:0 4px 10px rgba(0,0,0,0.8);
  }

  /* Search bar (matches) */
  body.dark-mode #searchMatches{
    background:#020617;
    color:#f9fafb;
    border-color:rgba(55,65,81,1);
  }
  body.dark-mode #searchMatches::placeholder{
    color:#9ca3af;
  }

  .hamburger-btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    border:0;
    background:rgba(255,255,255,0.9);
    font-size:22px;
    cursor:pointer;
    padding:6px 9px;
    border-radius:999px;
    box-shadow:0 4px 10px rgba(15,23,42,0.12);
    transition:background 0.2s ease,transform 0.1s ease,box-shadow 0.2s ease;
  }
  .hamburger-btn:hover{background:#fff}
  .hamburger-btn:active{transform:scale(0.96);box-shadow:0 2px 6px rgba(15,23,42,0.18)}
  .hamburger-btn:focus{outline:2px solid rgba(0,0,0,0.4)}

  /* Hide hamburger on desktop only */
  @media (min-width:901px){
    .hamburger-btn{display:none;}
  }

  .brand{display:flex;align-items:center;gap:12px}
  .logo{
    width:52px;height:52px;border-radius:12px;
    background:#ffffff;
    border:2px solid var(--accent);
    display:flex;align-items:center;justify-content:center;
    color:var(--accent);
    font-weight:900;letter-spacing:0.08em;
    box-shadow:0 8px 18px rgba(15,23,42,0.4);
  }

  @keyframes pulseGlow{
    0%,100%{box-shadow:0 0 0 rgba(0,0,0,0);} 
    50%{box-shadow:0 0 0 rgba(0,0,0,0);} 
  }
  .title{font-weight:900;font-size:16px}
  nav{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  nav button{
    background:transparent;
    border:0;
    padding:9px 10px;
    border-radius:10px;
    text-align:left;
    cursor:pointer;
    font-weight:700;
    color:var(--text);
    font-size:14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    transition:background 0.18s ease,color 0.18s ease,transform 0.08s ease;
  }
  nav button:hover{background:rgba(248,250,252,1)}
  nav button.disabled{opacity:0.4;pointer-events:none}
  nav button.active{
    background:linear-gradient(90deg,var(--accent-soft),rgba(248,250,252,1));
    color:var(--accent);
    transform:translateX(1px);
  }
  .grow{flex:1}

  .main{
    flex:1;
    padding:22px 24px 26px;
    overflow:auto;
    position:relative;
  }
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  header h1{
    margin:0;
    font-size:20px;
    color:var(--accent);
    font-weight:900;
    letter-spacing:0.02em;
  }

  .card{
    background:var(--card);
    border-radius:var(--radius-lg);
    padding:18px 20px;
    border:1px solid var(--border-subtle);
    box-shadow:var(--shadow-soft);
  }
  .muted{color:var(--muted)}
  .row{display:flex;gap:10px;align-items:center}

  /* Make inner flex rows wrap nicely on mobile */
  .card>div{display:flex;align-items:center;gap:8px}

  /* Home hero */
  .home-hero{
    display:flex;
    gap:26px;
    align-items:stretch;
  }
  .home-hero-left{
    flex:1.4;
    display:flex;
    flex-direction:column;
    gap:16px;
  }
  .home-hero-right{
    flex:1;
    display:flex;
    flex-direction:column;
    gap:14px;
    justify-content:space-between;
  }
  .pill-tag{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:6px 12px;
    border-radius:999px;
    background:rgba(248,250,252,0.95);
    border:1px solid rgba(226,232,240,1);
    font-size:12px;
    color:var(--muted);
    letter-spacing:0.08em;
    text-transform:uppercase;
  }
  .pill-dot{
    width:8px;height:8px;border-radius:999px;
    background:var(--accent);
  }
  .home-title{
    font-size:28px;
    line-height:1.2;
    font-weight:900;
  }
  .gradient-text{
    background:linear-gradient(120deg,var(--accent),var(--accent-2));
    background-size:140% 140%;
    -webkit-background-clip:text;
    color:transparent;
    animation:shineText 8s ease-in-out infinite;
  }
  @keyframes shineText{
    0%,100%{background-position:0% 50%;}
    50%{background-position:100% 50%;}
  }
  .home-subtitle{
    font-size:14px;
    color:var(--muted);
    max-width:480px;
  }
  .home-stats{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    margin-top:6px;
  }
  .stat-card{
    flex:1;
    min-width:130px;
    padding:10px 12px;
    border-radius:14px;
    background:linear-gradient(135deg,#ffffff,#fef2f2);
    border:1px solid rgba(229,231,235,1);
    box-shadow:0 8px 24px rgba(15,23,42,0.08);
    position:relative;
    overflow:hidden;
  }
  .stat-card::before{
    content:"";
    position:absolute;
    inset:auto;
  }
  .stat-value{
    font-size:22px;
    font-weight:900;
    letter-spacing:0.05em;
  }
  .stat-label{
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:0.14em;
    color:var(--muted);
  }
  .quote-card{
    padding:14px 16px;
    border-radius:18px;
    background:#ffffff;
    border:2px solid var(--accent);
    box-shadow:0 18px 40px rgba(15,23,42,0.12);
    position:relative;
    overflow:hidden;
    color:var(--text);
  }
  .quote-card::after{
    content:"";
    position:absolute;
    inset:auto;
  }
  .quote-label{
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:0.15em;
    color:var(--accent);
  }
  .quote-text{
    margin-top:6px;
    font-size:20px;
    font-weight:900;
    line-height:1.3;
    color:var(--accent);
  }
  .orbit-wrapper{
    position:relative;
    height:140px;
    margin-top:8px;
  }
  .orbit-ring{
    position:absolute;
    inset:22px;
    border-radius:50%;
    border:1px dashed rgba(148,163,184,0.6);
  }
  .orbit-dot{
    position:absolute;
    width:10px;height:10px;border-radius:999px;
    background:var(--accent);
  }
  @keyframes orbit{
    0%{transform:rotate(0deg) translateX(60px);} 
    100%{transform:rotate(360deg) translateX(60px);} 
  }

  /* Form & controls */
  .form-row{display:flex;gap:8px;margin-bottom:10px}
  .form-row label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input[type="text"], input[type="email"], select{
    width:100%;
    padding:10px 11px;
    border-radius:10px;
    border:1px solid var(--border-subtle);
    font-size:14px;
    background:#fdfdfd;
    transition:border-color 0.18s ease,box-shadow 0.18s ease,background 0.18s ease;
  }
  input[type="text"]:focus, input[type="email"]:focus, select:focus{
    outline:none;
    border-color:var(--accent);
    box-shadow:0 0 0 1px rgba(200,16,46,0.35);
    background:#ffffff;
  }

  .btn{
    padding:10px 13px;
    border-radius:999px;
    border:1px solid transparent;
    background:#e5e7eb;
    cursor:pointer;
    font-weight:800;
    font-size:13px;
    letter-spacing:0.02em;
    transition:background 0.18s ease,transform 0.08s ease,box-shadow 0.18s ease,color 0.18s ease,border-color 0.18s ease;
    white-space:nowrap;
    color:var(--text);
  }
  .btn:hover{background:#d1d5db;box-shadow:0 4px 10px rgba(15,23,42,0.18);}
  .btn:active{transform:scale(0.97);box-shadow:none}
  .btn.primary{
    background:linear-gradient(120deg,var(--accent),var(--accent-2));
    background-size:140% 140%;
    color:#f9fafb;
    border-color:transparent;
    box-shadow:0 8px 18px rgba(248,113,113,0.5);
    animation:none;
  }
  .btn.primary:hover{box-shadow:0 10px 24px rgba(248,113,113,0.8);filter:brightness(1.03);}
  .btn.ghost{background:#ffffff;border:1px solid rgba(148,163,184,0.6);color:var(--muted);}
  .btn.danger{background:linear-gradient(120deg,#b91c1c,#ef4444);color:#fee2e2;box-shadow:0 6px 16px rgba(248,113,113,0.7);}
  .btn[disabled]{opacity:0.45;cursor:not-allowed;box-shadow:none}
  .match-filter-active{
    background:radial-gradient(circle at top,rgba(248,113,113,0.28),rgba(15,23,42,0.98));
    color:#fee2e2;
    box-shadow:0 0 0 1px rgba(248,113,113,0.9);
  }

  /* Start scoring modal */
  .modal{
    position:fixed;
    left:50%;top:50%;transform:translate(-50%,-50%);
    width:520px;
    max-width:96vw;
    max-height:90vh;
    background:#ffffff;
    border-radius:18px;
    padding:18px 18px 16px;
    border:1px solid rgba(209,213,219,1);
    box-shadow:0 24px 70px rgba(15,23,42,0.25);
    display:none;
    z-index:2000;
    overflow-y:auto;
    color:var(--text);
  }
  .modal.show{display:block}
  .modal h3{margin:0 0 12px 0;color:var(--accent)}

  /* Matches list */
  .match-card{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:12px 13px;
    border-radius:12px;
    border:1px solid rgba(229,231,235,1);
    margin-bottom:10px;
    background:#ffffff;
    box-shadow:0 4px 12px rgba(15,23,42,0.06);
    transition:transform 0.12s ease,box-shadow 0.12s ease,background 0.15s ease;
    color:var(--text);
  }
  .match-card:hover{
    transform:translateY(-1px);
    box-shadow:0 10px 22px rgba(15,23,42,0.12);
    background:#fef2f2;
  }

  /* Desktop layout for match cards: equal size + hover grow */
  @media (min-width: 900px){
    #scSchedule .match-card,
    #matchesList .match-card,
    #liveList .match-card{
      width:100%;
      min-height:96px;
    }
    #scSchedule,
    #matchesList,
    #liveList{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .match-card:hover{
      transform:translateY(-4px) scale(1.02);
    }
  }

  .badge{padding:6px 10px;border-radius:999px;font-weight:900;font-size:11px}
  .live{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;}
  .done{background:linear-gradient(90deg,#16a34a,#4ade80);color:#ecfdf5;}
  .scheduled{background:#e5e7eb;color:var(--muted);border:1px solid rgba(209,213,219,1);}
  .winner{color:#2ecc71;font-weight:800}
  .loser{color:#e74c3c;font-weight:800}
  .tie{color:#f1c40f;font-weight:900}

  /* Scoring panel */
  #scoreSheet{
    display:none;
    position:fixed;
    inset:8% 8% auto 8%;
    z-index:1500;
    background:#ffffff;
    border-radius:20px;
    padding:18px 20px;
    border:1px solid rgba(209,213,219,1);
    box-shadow:0 24px 80px rgba(15,23,42,0.25);
    width:84%;
    max-width:1100px;
    max-height:84vh;
    overflow-y:auto;
    color:var(--text);
  }
  #scoreSheet.show{display:block}
  #scoreHead{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .scoreCenter{font-size:40px;font-weight:900;color:var(--accent)}
  .scoreControls{display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap}
  .teamBlock{
    flex:1;
    padding:12px;
    border-radius:12px;
    border:1px solid rgba(229,231,235,1);
    display:flex;
    flex-direction:column;
    gap:8px;
    align-items:center;
    background:#f9fafb;
  }

  /* Event log */
  .log{
    max-height:220px;
    overflow:auto;
    background:#f3f4f6;
    padding:8px;
    border-radius:10px;
    font-size:13px;
    border:1px solid rgba(209,213,219,1);
    color:var(--muted);
  }

  .pagination{
    display:flex;
    justify-content:center;
    gap:6px;
    font-size:13px;
    align-items:center;
    flex-wrap:wrap;
  }
  .pagination button{
    min-width:28px;
    padding:6px 8px;
    border-radius:999px;
    border:1px solid rgba(209,213,219,1);
    background:#ffffff;
    cursor:pointer;
    font-weight:700;
    font-size:12px;
    color:var(--muted);
    transition:background 0.15s ease,transform 0.08s ease,box-shadow 0.15s ease;
  }
  .pagination button:hover{background:#fef2f2;box-shadow:0 4px 10px rgba(15,23,42,0.12);color:var(--accent);}
  .pagination button:active{transform:scale(0.96)}
  .pagination button.active{
    background:linear-gradient(120deg,var(--accent),var(--accent-2));
    color:#fff;
  }
  .pagination button[disabled]{opacity:0.4;cursor:not-allowed}

  /* Auth overlay */
  .overlay{
    position:fixed;inset:0;
    background:rgba(15,23,42,0.55);
    display:none;align-items:center;justify-content:center;z-index:3000;
    backdrop-filter: blur(4px);
  }
  .pwbox{
    background:#ffffff;
    padding:20px 18px;
    border-radius:18px;
    width:420px;
    border:1px solid rgba(209,213,219,1);
    text-align:left;
    box-shadow:0 24px 70px rgba(15,23,42,0.25);
    color:var(--text);
  }
  .pwbox h2{color:var(--accent);margin-bottom:8px}
  .pwbox input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(209,213,219,1);margin-top:6px;background:#f9fafb;color:var(--text);}
  .small-muted{font-size:13px;color:var(--muted)}

  /* Responsive */
  @media (max-width:900px){
    body{flex-direction:column}

    .sidebar{
      position:fixed;
      z-index:4000;
      left:0;top:0;bottom:0;
      background:#ffffff !important;
      width:260px;
      box-shadow:16px 0 40px rgba(15,23,42,0.12);
      transform:translateX(-100%);
      transition:transform 0.25s ease,box-shadow 0.25s ease;
      display:flex;
    }
    .sidebar.mobile-open{transform:translateX(0)}

    .main{padding:16px 14px 20px}
    header h1{font-size:18px}

    .card{padding:14px 14px;border-radius:14px}
    .card>div{flex-wrap:wrap;align-items:flex-start}

    /* Center match lists & ensure one card per row on mobile */
    #scSchedule,
    #matchesList,
    #liveList{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:center;
    }

    #scSchedule .match-card,
    #matchesList .match-card,
    #liveList .match-card{
      width:100%;
      max-width:480px;
    }

    #scoreSheet{
      inset:0;
      width:100%;
      max-width:none;
      border-radius:0;
      max-height:100vh;
    }

    .modal{
      inset:12px;
      width:auto;
      max-width:none;
      left:12px;right:12px;top:12px;bottom:12px;
      transform:none;
      border-radius:14px;
    }
  }

  @media (max-width:600px){
    header{align-items:flex-start;flex-direction:column;gap:6px}
    .badge{font-size:10px;padding-inline:8px}
    .scoreCenter{font-size:32px}
    .teamBlock{padding:10px}
  }
</style>
</head>
<body>

<div class="sidebar">
  <div class="brand">
    <div class="logo">GO</div>
    <div>
      <div class="title">GO 2025</div>
      <div class="muted" style="font-size:13px">Gurukul Olympics</div>
    </div>
  </div>

  <nav aria-label="main-nav">
    <button data-tab="home" class="active">Home</button>
    <button data-tab="sports">Sports</button>
    <button data-tab="scoring">Scoring</button>
    <button data-tab="matches">Matches</button>
    <button data-tab="live">Live</button>
    <button data-tab="users">Users</button>
    <div class="grow"></div>

    <div id="authArea">
      <div style="font-size:13px;color:var(--muted);margin-bottom:6px">You are:</div>
      <div id="signedOut" style="display:block">
        <button id="btnShowAuth" class="btn primary">Sign in / Register</button>
      </div>
      <div id="signedIn" style="display:none">
        <div id="userName" style="font-weight:800"></div>
        <div class="muted" id="userEmail" style="font-size:13px"></div>
        <div style="height:8px"></div>
        <button id="btnSignOut" class="btn ghost">Sign out</button>
      </div>
    </div>

    <!-- Dark mode toggle -->
    <div style="margin-top:12px;padding-top:10px;border-top:1px solid rgba(229,231,235,1);font-size:13px;color:var(--muted);">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
        <span>Dark mode</span>
        <button id="toggleDarkMode" class="btn" style="padding:6px 10px;font-size:12px;">Off</button>
      </div>
    </div>

  </nav>
</div>

<div class="main">
  <header>
    <div style="display:flex;align-items:center;gap:8px">
      <button id="hamburgerBtn" class="hamburger-btn" aria-label="Toggle navigation">‚ò∞</button>
      <h1>GO 2025 ‚Äî Scoring</h1>
    </div>
    <div class="muted">‚Ä¢ Realtime DB ‚Ä¢ SPA</div>
  </header>

  <div style="height:14px"></div>

  <section id="home" class="card tab" style="display:block">
    <div class="home-hero">
      <div class="home-hero-left">
        <div class="pill-tag">
          <span class="pill-dot"></span>
          Gurukul Olympics 2025 ‚Ä¢ Live Scoring
        </div>
        <h2 class="home-title">
          Realtime scoring,<br/>
          <span class="gradient-text"></span>
        </h2>
        <p class="home-subtitle">
          Track every point from the arena with a fast, tournament-ready scoring system for Gurukul Olympics 2025.
        </p>

        <div class="home-stats">
          <div class="stat-card floating">
            <div class="stat-value gradient-text">134</div>
            <div class="stat-label">Registered schools</div>
          </div>
          <div class="stat-card floating" style="animation-delay:0.4s">
            <div class="stat-value gradient-text">13,000+</div>
            <div class="stat-label">Participants</div>
          </div>
        </div>
      </div>

      <div class="home-hero-right">
        <div class="quote-card">
          <div class="quote-label">Gurukul motto</div>
          <div class="quote-text gradient-text">
            ‚ÄúKhelo Gurukul mein, jeeto duniya mein‚Äù
          </div>
        </div>
        <div class="orbit-wrapper">
          <div class="orbit-ring"></div>
          <div class="orbit-dot"></div>
        </div>
      </div>
    </div>
  </section>

  <section id="sports" class="tab" style="display:none">
    <div class="card">
      <h2>All Sports</h2>
      <p class="muted">Select a sport while starting scoring.</p>
      <div id="sportsGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:12px"></div>
    </div>
  </section>

  <section id="scoring" class="tab" style="display:none">
    <div class="card">
      <h2>Scoring Hub</h2>
      <div style="display:flex;gap:10px;align-items:center;margin-top:10px">
        <button id="btnStartScoring" class="btn primary">Start Scoring</button>
        <div style="flex:1"></div>
        <div class="muted">Matches are persisted to Realtime DB and broadcast live.</div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
        <label style="font-size:13px;color:var(--muted)">Sport</label>
        <select id="filterSportScoring" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"><option value="all">All</option></select>
        <label style="font-size:13px;color:var(--muted)">Age</label>
        <select id="filterAgeScoring" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"><option value="all">All</option></select>
        <div style="flex:1"></div>
        <input id="searchScoring" placeholder="Search team, sport..." style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"/>
      </div>

      <div id="scSchedule" style="margin-top:14px"></div>
      <div id="scScoringPagination" class="pagination" style="margin-top:16px;display:none"></div>
    </div>
  </section>

  <section id="matches" class="tab" style="display:none">
    <div class="card">
      <h2>Matches</h2>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <button id="filterAll" class="btn ghost">All</button>
        <button id="filterLive" class="btn">Live</button>
        <button id="filterFinished" class="btn">Finished</button>

        <div style="width:12px"></div>
        <label style="font-size:13px;color:var(--muted)">Sport</label>
        <select id="filterSportMatches" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"><option value="all">All</option></select>
        <label style="font-size:13px;color:var(--muted)">Age</label>
        <select id="filterAgeMatches" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"><option value="all">All</option></select>

        <div style="flex:1"></div>
        <input id="searchMatches" placeholder="Search team, sport..." style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"/>
      </div>
      <div id="matchesList" style="margin-top:12px"></div>
      <div id="matchesPagination" class="pagination" style="margin-top:16px;display:none"></div>
    </div>
  </section>

  <section id="live" class="tab" style="display:none">
    <div class="card">
      <h2>Live Matches</h2>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <label style="font-size:13px;color:var(--muted)">Sport</label>
        <select id="filterSportLive" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"><option value="all">All</option></select>
        <label style="font-size:13px;color:var(--muted)">Age</label>
        <select id="filterAgeLive" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"><option value="all">All</option></select>
      </div>
      <div id="liveList" style="margin-top:12px"></div>
      <div id="livePagination" class="pagination" style="margin-top:16px;display:none"></div>
    </div>
  </section>

  <section id="users" class="tab" style="display:none">
    <div class="card">
      <h2>Users</h2>
      <div id="usersAdminArea" style="margin-top:8px"></div>
      <h3 style="margin-top:12px">Pending Users</h3>
      <div id="pendingList" style="margin-bottom:12px"></div>
      <h3>Whitelisted Users</h3>
      <div id="whitelistList"></div>
    </div>
  </section>

  <div style="height:24px"></div>
  <footer class="muted">Made for GO 2025 ‚Ä¢ Red & White theme</footer>
</div>

<div id="startModal" class="modal" role="dialog" aria-modal="true">
  <h3>Start Scoring</h3>

  <div style="display:flex;gap:10px">
    <div style="flex:1">
      <label>Sport</label>
      <select id="mSport"></select>
    </div>
    <div style="width:12px"></div>
    <div style="flex:1">
      <label>Age Category</label>
      <select id="mAge"></select>
    </div>
  </div>

  <div style="height:10px"></div>

  <div class="form-row">
    <div style="flex:1">
      <label>Team A (School)</label>
      <input id="mTeamA" type="text" placeholder="Team A name" />
    </div>
    <div style="width:10px"></div>
    <div style="flex:1">
      <label>Team B (School)</label>
      <input id="mTeamB" type="text" placeholder="Team B name" />
    </div>
  </div>

  <div style="height:12px"></div>

  <div style="display:flex;justify-content:flex-end;gap:8px">
    <button id="startCancel" class="btn ghost">Cancel</button>
    <button id="startCreate" class="btn primary">Create & Start</button>
  </div>
</div>

  <div id="scoreSheet" aria-hidden="true">
  <div id="scoreHead">
    <div>
      <div id="sheetTitle" style="font-weight:900;font-size:18px;color:var(--accent)"></div>
      <div id="sheetMeta" class="muted" style="font-size:13px"></div>
      <div id="refereeLine" class="muted" style="font-size:13px;margin-top:2px"></div>
      <div id="winnerLoserHeader" style="margin-top:4px;font-size:13px"></div>
    </div>
    <div>
      <button id="closeScore" class="btn ghost">Close</button>
    </div>
  </div>

  <div style="height:12px"></div>

  <div style="display:flex;gap:12px">
    <div class="teamBlock">
      <div id="teamAName" style="font-weight:900"></div>
      <div id="teamASchool" class="muted" style="font-size:13px"></div>
      <div style="height:8px"></div>
      <div style="font-size:32px;font-weight:900" id="teamAScore">0</div>
      <div class="scoreControls" id="teamAControls">
        </div>
    </div>

    <div style="width:24px;display:flex;align-items:center;justify-content:center">
      <div class="scoreCenter" id="scoreCenter">-</div>
    </div>

    <div class="teamBlock">
      <div id="teamBName" style="font-weight:900"></div>
      <div id="teamBSchool" class="muted" style="font-size:13px"></div>
      <div style="height:8px"></div>
      <div style="font-size:32px;font-weight:900" id="teamBScore">0</div>
      <div class="scoreControls" id="teamBControls">
        </div>
    </div>
  </div>

  <div style="height:12px"></div>

  <div style="display:flex;gap:10px;align-items:center;justify-content:space-between">
    <div style="display:flex;gap:8px">
      <button id="saveProgress" class="btn">Save</button>
      <button id="finishMatch" class="btn danger">Finish Match</button>
      <button id="resetMatch" class="btn ghost">Reset</button>
    </div>
    <div class="muted">
      <span id="statusLabel">LIVE</span>
      &nbsp;‚Ä¢&nbsp;
      <span id="timeLabel">00:00</span>
    </div>
  </div>

  <div style="height:12px"></div>

  <!-- Volleyball: per-set summary & Next Set control -->
  <div id="volleyballSetsArea" style="display:none;margin-bottom:8px">
    <h4 style="margin:6px 0">Sets</h4>
    <div id="volleyballSetsList" class="log" style="max-height:120px"></div>
    <div style="margin-top:6px;display:flex;gap:8px;align-items:center">
      <div class="muted" id="currentSetLabel">Current set: 1</div>
      <button id="btnNextSet" class="btn">Next Set</button>
    </div>
  </div>

  <div class="event-log-section" style="margin-top:4px;">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
      <h4 style="margin:6px 0">Event Log</h4>
      <button id="toggleEventLog" class="btn ghost" style="padding:4px 10px;font-size:12px;">Show events</button>
    </div>
    <div id="eventLogWrapper" style="margin-top:6px;display:none;">
      <div id="eventLog" class="log"></div>
    </div>
  </div>

</div>

<!-- Match info overlay -->
<div class="overlay" id="matchInfoOverlay" style="display:none">
  <div class="pwbox card" style="text-align:left;max-width:520px">
    <h2 id="matchInfoTitle" style="margin-bottom:8px;color:var(--accent)">Match details</h2>
    <div id="matchInfoMeta" class="muted" style="font-size:13px;margin-bottom:10px"></div>
    <div id="matchInfoContent" style="font-size:14px;line-height:1.5"></div>
    <div style="height:12px"></div>
    <div style="text-align:right"><button id="matchInfoClose" class="btn ghost">Close</button></div>
  </div>
</div>

<div class="overlay" id="authOverlay" style="display:none">
  <div class="pwbox card" style="text-align:left;max-width:420px">
    <img alt="logo" src="" style="height:48px;margin-bottom:8px"/>
    <h2 id="authTitle">Welcome ‚Äî Sign In / Register</h2>

    <div style="display:flex;gap:8px;margin-bottom:8px" id="authTabs">
      <button id="tabRegister" class="btn primary" style="flex:1">Register</button>
      <button id="tabLogin" class="btn" style="flex:1">Login</button>
    </div>

    <div id="registerForm">
      <label>Email</label>
      <input autocomplete="email" id="regEmail" placeholder="you@school.edu" type="email"/>
      <label style="margin-top:8px">Confirm Email</label>
      <input autocomplete="off" id="regEmailConfirm" placeholder="confirm email" type="email"/>
      <div style="height:8px"></div>
      <button id="regBtn" class="btn primary" style="width:100%">Register (request access)</button>
      <div id="regMsg" style="margin-top:8px;color:#8f8;display:none"></div>
      <div style="height:8px"></div>
      <button id="regGoogleBtn" class="btn" style="width:100%;background:#eee;color:#111;font-weight:700;margin-top:6px">
        <span style="margin-right:8px">üîµ</span> Sign in with Google
      </button>
    </div>

    <div id="loginForm" style="display:none">
      <label>Email</label>
      <input autocomplete="email" id="loginEmail" placeholder="your registered email" type="email"/>
      <div style="height:8px"></div>
      <button id="loginBtn" class="btn primary" style="width:100%">Send Sign-in Link</button>
      <div id="loginMsg" style="margin-top:8px;color:#8f8;display:none"></div>
      <div style="height:8px"></div>
      <button id="loginGoogleBtn" class="btn primary" style="width:100%;margin-top:6px;background:#4285F4;color:#fff;font-weight:900">
        Sign in with Google
      </button>

      <div style="margin-top:10px">
        <label style="font-size:13px;color:var(--muted)">Upgrade / Bypass code (optional)</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <input id="upgradeCode" placeholder="Enter code (admins only)" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"/>
          <button id="codeAccessBtn" class="btn primary">Enter Code</button>
        </div>
        <div id="codeAccessMsg" class="small-muted" style="display:none;margin-top:6px"></div>
      </div>
    </div>

    <div id="authNote" style="margin-top:10px;color:var(--muted);font-size:13px">
      We use Firebase passwordless email sign-in (magic link). Register to request access ‚Äî admins approve registered users.
    </div>
    <div style="height:8px"></div>
    <div style="text-align:right"><button id="authClose" class="btn ghost">Close</button></div>
  </div>
</div>

<script>
/* =========================
   Firebase config - KEEP your own project's values here
   ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyDfiPPYg1bnHlwMj3ctjsY5o9RM8LWB-4s",
  authDomain: "go2025-new.firebaseapp.com",
  projectId: "go2025-new",
  storageBucket: "go2025-new.firebasestorage.app",
  messagingSenderId: "527350736849",
  appId: "1:527350736849:web:12fb093267f66f71a962f0",
  measurementId: "G-D18JX8N3ET"
  // add databaseURL if needed
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const rtdb = firebase.database(); // original scoring functions depend on RTDB
const db = firebase.firestore();  // used for whitelist/pending/registeredUsers

/* =========================
   Constants & state
   ========================= */
const UPGRADE_ADMIN_CODE = 'NeverThinkGurukul35'; // temporary bypass code for admin sessions (change/remove in production)
const actionCodeSettings = {
  url: window.location.href,
  handleCodeInApp: true,
};

let localSessionRole = null; // used when bypass code grants session role

/* =========================
   DOM refs
   ========================= */
const btnShowAuth = document.getElementById('btnShowAuth');
const authOverlay = document.getElementById('authOverlay');
const authClose = document.getElementById('authClose');

// Match info overlay elements
const matchInfoOverlay = document.getElementById('matchInfoOverlay');
const matchInfoTitle = document.getElementById('matchInfoTitle');
const matchInfoMeta = document.getElementById('matchInfoMeta');
const matchInfoContent = document.getElementById('matchInfoContent');
const matchInfoClose = document.getElementById('matchInfoClose');
const tabRegister = document.getElementById('tabRegister');
const tabLogin = document.getElementById('tabLogin');

const registerForm = document.getElementById('registerForm');
const loginForm = document.getElementById('loginForm');

const regEmail = document.getElementById('regEmail');
const regEmailConfirm = document.getElementById('regEmailConfirm');
const regBtn = document.getElementById('regBtn');
const regMsg = document.getElementById('regMsg');

const loginEmail = document.getElementById('loginEmail');
const loginBtn = document.getElementById('loginBtn');
const loginMsg = document.getElementById('loginMsg');

const regGoogleBtn = document.getElementById('regGoogleBtn');
const loginGoogleBtn = document.getElementById('loginGoogleBtn');

const upgradeCodeInput = document.getElementById('upgradeCode');
const codeAccessBtn = document.getElementById('codeAccessBtn');
const codeAccessMsg = document.getElementById('codeAccessMsg');

const signedOutArea = document.getElementById('signedOut');
const signedInArea = document.getElementById('signedIn');
const btnSignOut = document.getElementById('btnSignOut');
const userNameEl = document.getElementById('userName');
const userEmailEl = document.getElementById('userEmail');

const navButtons = document.querySelectorAll('nav button[data-tab], nav button');
const sidebarEl = document.querySelector('.sidebar');
const hamburgerBtn = document.getElementById('hamburgerBtn');
const toggleDarkModeBtn = document.getElementById('toggleDarkMode');

if(hamburgerBtn && sidebarEl){
  hamburgerBtn.addEventListener('click', ()=>{
    sidebarEl.classList.toggle('mobile-open');
  });

  // Close mobile sidebar when clicking outside it
  document.addEventListener('click', (e)=>{
    if(window.innerWidth > 900) return; // desktop: ignore
    if(!sidebarEl.classList.contains('mobile-open')) return;
    const target = e.target;
    if(sidebarEl.contains(target) || hamburgerBtn.contains(target)) return;
    sidebarEl.classList.remove('mobile-open');
  });
}

// Simple dark mode toggle (sidebar + search bar)
function setDarkMode(isDark){
  if(isDark){
    document.body.classList.add('dark-mode');
    if(toggleDarkModeBtn) toggleDarkModeBtn.textContent = 'On';
  } else {
    document.body.classList.remove('dark-mode');
    if(toggleDarkModeBtn) toggleDarkModeBtn.textContent = 'Off';
  }
}

(function initDarkMode(){
  const saved = (localStorage.getItem('go_darkMode') === '1');
  setDarkMode(saved);
  if(toggleDarkModeBtn){
    toggleDarkModeBtn.addEventListener('click', ()=>{
      const current = document.body.classList.contains('dark-mode');
      const next = !current;
      setDarkMode(next);
      localStorage.setItem('go_darkMode', next ? '1' : '0');
    });
  }
})();

const usersTabBtn = document.querySelector('nav button[data-tab="users"]');
const pendingList = document.getElementById('pendingList');
const whitelistList = document.getElementById('whitelistList');
const usersAdminArea = document.getElementById('usersAdminArea');

/* =========================
   Utility helpers
   ========================= */
function encodeEmailKey(email){ return encodeURIComponent((email||'').toLowerCase()); }
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* =========================
   Whitelist / Pending helpers (Firestore)
   registeredUsers collection: doc id = encodeURIComponent(email)
   pendingUsers collection: doc id = encodeURIComponent(email)
*/
async function isWhitelisted(email){
  if(!email) return false;
  const doc = await db.collection('registeredUsers').doc(encodeEmailKey(email)).get();
  return doc.exists;
}
async function addToPending(email){
  if(!email) return;
  await db.collection('pendingUsers').doc(encodeEmailKey(email)).set({
    email: email,
    requestedAt: new Date().toISOString()
  });
}
async function loadUsersTab(){
  // Admin-only area: show quick add
  usersAdminArea.innerHTML = '';
  const curRole = getSessionRole();
  if(curRole === 'admin'){
    const row = document.createElement('div');
    row.innerHTML = `
      <div style="display:flex;gap:8px;align-items:center">
        <input id="whitelistEmailInput" placeholder="Enter email to whitelist (admin-only)" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"/>
        <select id="whitelistRoleSelect" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);margin-left:6px">
          <option value="user">user</option>
          <option value="teacher">teacher</option>
          <option value="admin">admin</option>
        </select>
        <button id="addWhitelistBtn" class="btn primary">Add</button>
      </div>
      <div id="addWhitelistMsg" style="margin-top:8px"></div>
    `;
    usersAdminArea.appendChild(row);
    document.getElementById('addWhitelistBtn').addEventListener('click', async ()=>{
      const em = (document.getElementById('whitelistEmailInput').value||'').trim().toLowerCase();
      const role = document.getElementById('whitelistRoleSelect').value || 'user';
      const m = document.getElementById('addWhitelistMsg');
      m.innerText = '';
      if(!em){ m.innerText = 'Enter email'; return; }
      try{
        await db.collection('registeredUsers').doc(encodeEmailKey(em)).set({
          email: em,
          role: role,
          createdAt: new Date().toISOString(),
          manualWhitelistBy: (getSessionEmail()||'system')
        });
        m.innerText = `Whitelisted ${em} as ${role}.`;
        await refreshUsersLists();
      }catch(e){ m.innerText = 'Failed. See console.'; console.error(e); }
    });
  }

  pendingList.innerHTML = 'Loading...'; whitelistList.innerHTML = 'Loading...';
  await refreshUsersLists();
}
async function refreshUsersLists(){
  const pSnap = await db.collection('pendingUsers').get();
  const wSnap = await db.collection('registeredUsers').get();
  if(pSnap.empty) pendingList.innerHTML = '<div class="muted">No pending users</div>';
  else pendingList.innerHTML = pSnap.docs.map(d=>{
    const em = escapeHtml(d.data().email||d.id);
    const idSafe = d.id;
    return `<div style="margin:6px 0;padding:8px;background:#f8f8f8;border-radius:6px;display:flex;justify-content:space-between;align-items:center;gap:8px">
      <div style="font-weight:800">${em}</div>
      <div style="display:flex;align-items:center;gap:6px;font-size:12px">
        <span class="muted">Role:</span>
        <select id="pendingRole-${idSafe}" style="padding:4px 6px;border-radius:6px;border:1px solid rgba(0,0,0,0.06);font-size:12px">
          <option value="user">user</option>
          <option value="teacher">teacher</option>
          <option value="admin">admin</option>
        </select>
      </div>
      <div style=\"display:flex;gap:8px\">
        <button class=\"btn primary\" onclick=\"approveUser('${idSafe}')\">Approve</button>
        <button class=\"btn danger\" onclick=\"rejectUser('${idSafe}')\">Reject</button>
      </div>
    </div>`;
  }).join('');

  if(wSnap.empty) whitelistList.innerHTML = '<div class="muted">No whitelisted users</div>';
  else whitelistList.innerHTML = wSnap.docs.map(d=>{
    const data = d.data();
    const em = escapeHtml(data.email || d.id);
    const roleRaw = data.role || 'user';
    const role = escapeHtml(roleRaw);
    const idSafe = d.id;
    return `<div style="margin:6px 0;padding:8px;background:#f4f4f4;border-radius:6px;display:flex;flex-direction:column;gap:6px;width:100%;box-sizing:border-box">
      <div style="font-weight:800;display:flex;flex-wrap:wrap;align-items:center;gap:6px">
        <span>${em}</span>
        <span style="font-size:12px;padding:2px 8px;border-radius:999px;background:rgba(0,0,0,0.04);color:#374151">${role}</span>
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;font-size:12px">
        <span class="muted">Change to:</span>
        <select id="wlRole-${idSafe}" style="padding:4px 6px;border-radius:6px;border:1px solid rgba(0,0,0,0.06);font-size:12px">
          <option value="user" ${roleRaw==='user'?'selected':''}>user</option>
          <option value="teacher" ${roleRaw==='teacher'?'selected':''}>teacher</option>
          <option value="admin" ${roleRaw==='admin'?'selected':''}>admin</option>
        </select>
        <button class="btn" style="padding:4px 10px;font-size:12px" onclick="updateWhitelistRole('${idSafe}')">Update</button>
        <button class=\"btn danger\" style="padding:4px 10px;font-size:12px" onclick=\"removeWhitelist('${idSafe}')\">Remove</button>
      </div>
    </div>`;
  }).join('');
}

window.approveUser = async function(id){
  try{
    const doc = await db.collection('pendingUsers').doc(id).get();
    if(!doc.exists) { alert('Not found'); return; }
    const email = doc.data().email;
    const roleSelect = document.getElementById(`pendingRole-${id}`);
    const role = roleSelect && roleSelect.value ? roleSelect.value : 'user';
    await db.collection('registeredUsers').doc(id).set({
      email: email,
      role: role,
      approvedAt: new Date().toISOString(),
      approvedBy: getSessionEmail()||'system'
    });
    await db.collection('pendingUsers').doc(id).delete();
    await refreshUsersLists();
  }catch(e){ console.error(e); alert('Failed to approve.'); }
};
window.rejectUser = async function(id){
  try{ await db.collection('pendingUsers').doc(id).delete(); await refreshUsersLists(); }catch(e){ console.error(e); alert('Failed'); }
};
window.removeWhitelist = async function(id){
  try{ await db.collection('registeredUsers').doc(id).delete(); await refreshUsersLists(); }catch(e){ console.error(e); alert('Failed'); }
};
window.updateWhitelistRole = async function(id){
  try{
    const select = document.getElementById(`wlRole-${id}`);
    if(!select){ alert('Role selector not found'); return; }
    const newRole = select.value || 'user';
    const docRef = db.collection('registeredUsers').doc(id);
    const snap = await docRef.get();
    if(!snap.exists){ alert('User not found'); return; }
    await docRef.update({ role: newRole });
    await refreshUsersLists();
  }catch(e){ console.error(e); alert('Failed to update role'); }
};

/* =========================
   Auth UI interactions
*/
btnShowAuth.addEventListener('click', ()=> { authOverlay.style.display='flex'; tabRegister.click(); });
authClose.addEventListener('click', ()=> { authOverlay.style.display='none'; });
if(matchInfoClose && matchInfoOverlay){
  matchInfoClose.addEventListener('click', ()=> { matchInfoOverlay.style.display='none'; });
}

// Auth tabs
tabRegister.addEventListener('click', ()=> { tabRegister.classList.add('primary'); tabLogin.classList.remove('primary'); registerForm.style.display='block'; loginForm.style.display='none'; });
tabLogin.addEventListener('click', ()=> { tabLogin.classList.add('primary'); tabRegister.classList.remove('primary'); loginForm.style.display='block'; registerForm.style.display='none'; });

regBtn.addEventListener('click', async ()=>{
  const e = (regEmail.value||'').trim().toLowerCase();
  const c = (regEmailConfirm.value||'').trim().toLowerCase();
  regMsg.style.display='none';
  if(!e || !c){ regMsg.style.display='block'; regMsg.style.color='#f88'; regMsg.innerText='Please enter and confirm your email.'; return; }
  if(e !== c){ regMsg.style.display='block'; regMsg.style.color='#f88'; regMsg.innerText='Emails do not match.'; return; }
  try{
    // add to pending
    await db.collection('pendingUsers').doc(encodeEmailKey(e)).set({ email: e, requestedAt: new Date().toISOString() });
    regMsg.style.display='block'; regMsg.style.color='#8f8'; regMsg.innerText='Request submitted ‚Äî wait for approval.';
    regEmail.value=''; regEmailConfirm.value='';
    // switch to login to await sign-in link once approved
    tabLogin.click();
  }catch(err){
    console.error(err); regMsg.style.display='block'; regMsg.style.color='#f88'; regMsg.innerText='Registration failed. See console.';
  }
});

// Email link sign-in handler
loginBtn.addEventListener('click', async ()=>{
  const e = (loginEmail.value||'').trim().toLowerCase();
  loginMsg.style.display='none';
  if(!e){ loginMsg.style.display='block'; loginMsg.style.color='#f88'; loginMsg.innerText='Enter your registered email.'; return; }
  try{
    const doc = await db.collection('registeredUsers').doc(encodeEmailKey(e)).get();
    if(!doc.exists){
      loginMsg.style.display='block'; loginMsg.style.color='#f88'; loginMsg.innerText='Email not registered. Register first or request approval.';
      // optionally add to pending
      await addToPending(e);
      return;
    }
    await auth.sendSignInLinkToEmail(e, actionCodeSettings);
    window.localStorage.setItem('emailForSignIn', e);
    loginMsg.style.display='block'; loginMsg.style.color='#8f8'; loginMsg.innerText='Sign-in link sent. Check your email.';
    loginEmail.value='';
  }catch(err){
    console.error(err); loginMsg.style.display='block'; loginMsg.style.color='#f88'; loginMsg.innerText='Failed to send link. See console.';
  }
});

// Google sign-in (shared for register and login buttons)
async function handleGoogleSignIn(){
  const provider = new firebase.auth.GoogleAuthProvider();
  try{
    const result = await auth.signInWithPopup(provider);
    const user = result.user;
    if(user && user.email){
      const email = (user.email||'').toLowerCase();
      // if there's no registeredUsers entry, create one (or leave pending depending on your policy)
      const ref = db.collection('registeredUsers').doc(encodeEmailKey(email));
      const snap = await ref.get();
      if(!snap.exists){
        // Create registeredUsers doc but mark it approved if you want auto-allow; here we create as pending-like but we will allow sign-in only if whitelisted below
        // For safety, we won't auto-approve: create record only if you want to.
        // We'll allow sign-in only if whitelisted; otherwise add to pending and sign out.
        await addToPending(email);
      }
      // Check whitelist
      const wh = await isWhitelisted(email);
      if(!wh){
        alert('Your account is not whitelisted yet. A request has been added. Sign-in blocked for now.');
        await addToPending(email);
        await auth.signOut();
        return;
      }
      // whitelisted -> allow and show app
      authOverlay.style.display = 'none';
      showSignedInUIForEmail(email);
      // close overlay and show app
    }
  }catch(err){
    console.error('Google sign-in failed', err);
    alert('Google sign-in failed. See console.');
  }
}
if(regGoogleBtn) regGoogleBtn.addEventListener('click', handleGoogleSignIn);
if(loginGoogleBtn) loginGoogleBtn.addEventListener('click', handleGoogleSignIn);

// Admin bypass code (session-only)
codeAccessBtn.addEventListener('click', async ()=>{
  const email = (loginEmail.value||'').trim().toLowerCase();
  const code = (upgradeCodeInput.value||'').trim();
  codeAccessMsg.style.display = 'block';
  if(!email){ codeAccessMsg.style.color='red'; codeAccessMsg.innerText = 'Enter an email first.'; return; }
  if(code !== UPGRADE_ADMIN_CODE){ codeAccessMsg.style.color='red'; codeAccessMsg.innerText = 'Invalid code.'; return; }
  // grant session admin role (localStorage)
  localStorage.setItem('go_currentEmail', email);
  localStorage.setItem('go_currentRole', 'admin');
  localStorage.setItem('go_displayName', email.split('@')[0] || email);
  localSessionRole = 'admin';
  codeAccessMsg.style.color='green';
  codeAccessMsg.innerText = 'Temporary admin session granted for ' + email;
  // hide overlay and update UI
  authOverlay.style.display = 'none';
  applyRoleToUI('admin');
  showUserBadge();
  await loadUsersTab();
});

// Handle passwordless email sign-in completion (if page loaded from email link)
if (auth.isSignInWithEmailLink && auth.isSignInWithEmailLink(window.location.href)) {
  // complete sign-in
  let email = window.localStorage.getItem('emailForSignIn') || '';
  if (!email) {
    email = window.prompt('Please enter your email to complete sign-in:');
  }
  if (email) {
    auth.signInWithEmailLink(email, window.location.href).then(async (result) => {
      window.localStorage.removeItem('emailForSignIn');
      // check whitelist
      const wh = await isWhitelisted(email);
      if(!wh){
        // sign user out and show overlay with notice
        await auth.signOut();
        alert('Your account is not whitelisted yet. Request is in queue.');
        await addToPending(email);
        authOverlay.style.display = 'flex';
        return;
      }
      authOverlay.style.display = 'none';
      showSignedInUIForEmail(email);
    }).catch(err=>{
      console.error('Error completing sign-in:', err);
      alert('Sign-in failed. See console.');
      authOverlay.style.display = 'flex';
    });
  } else {
    // no email ‚Äî show overlay
    authOverlay.style.display = 'flex';
  }
}

/* =========================
   Auth state & session helpers
*/
function getSessionEmail(){
  // prefer firebase user if signed in, else localStorage fallback for code bypass
  try{
    const u = auth.currentUser;
    if(u && u.email) return u.email.toLowerCase();
  }catch(e){}
  return localStorage.getItem('go_currentEmail') || null;
}
function getSessionRole(){
  // prefer local admin bypass if present, else registeredUsers role in localStorage (set on sign-in)
  const r1 = localSessionRole || localStorage.getItem('go_currentRole') || null;
  return r1;
}
function setSessionForUser(email, role, displayName){
  if(email) localStorage.setItem('go_currentEmail', email.toLowerCase());
  if(role) localStorage.setItem('go_currentRole', role);
  if(displayName) localStorage.setItem('go_displayName', displayName);
}
function clearSession(){
  localStorage.removeItem('go_currentEmail');
  localStorage.removeItem('go_currentRole');
  localStorage.removeItem('go_displayName');
  localSessionRole = null;
}

btnSignOut.addEventListener('click', async ()=>{
  try{
    await auth.signOut();
  }catch(e){}
  clearSession();
  updateSignedInSignedOutUI(false);
  restrictUIForRole(null);
  if(authOverlay) authOverlay.style.display = 'flex';
});

/* Show signed-in UI (used after successful sign-in) */
async function showSignedInUIForEmail(email){
  if(!email) return;
  // look up role from registeredUsers
  try{
    const doc = await db.collection('registeredUsers').doc(encodeEmailKey(email)).get();
    let role = 'user';
    if(doc.exists){
      const d = doc.data();
      role = d.role || 'user';
    } else {
      // if not found, treat as pending ‚Äî put them into pending
      await addToPending(email);
      role = 'queued';
    }
    // persist session
    setSessionForUser(email, role, (email.split('@')[0]||email));
    updateSignedInSignedOutUI(true);
    applyRoleToUI(role);
    if(role === 'admin') await loadUsersTab();
    authOverlay.style.display = 'none';
  }catch(e){ console.error(e); alert('Sign-in succeeded but something failed. See console.'); }
}

/* Update header auth area */
function updateSignedInSignedOutUI(signedIn){
  if(signedIn){
    signedInArea.style.display = 'block';
    signedOutArea.style.display = 'none';
    const name = localStorage.getItem('go_displayName') || (getSessionEmail()||'').split('@')[0] || '';
    const email = getSessionEmail() || '';
    userNameEl.innerText = name;
    userEmailEl.innerText = email;
  } else {
    signedInArea.style.display = 'none';
    signedOutArea.style.display = 'block';
    userNameEl.innerText = '';
    userEmailEl.innerText = '';
  }
}

/* Show user badge in top-right (or update sidebar area) */
function showUserBadge(){
  try{
    const name = localStorage.getItem('go_displayName') || (getSessionEmail()||'').split('@')[0] || 'Guest';
    const role = localStorage.getItem('go_currentRole') || 'user';
    userNameEl.innerText = name;
    userEmailEl.innerText = getSessionEmail() || '';
    signedInArea.style.display = 'block'; signedOutArea.style.display='none';
  }catch(e){ console.warn('showUserBadge', e); }
}

/* =========================
   Role -> UI restrictions
   Roles:
   - queued / in-que / null => only Home
   - user => Home, Live, Matches
   - teacher => Home, Sports, Scoring, Matches, Live
   - admin => everything (Home, Sports, Scoring, Matches, Live, Users)
*/
function restrictUIForRole(role){
  // Normalize role string
  const r = (role || '').toString().toLowerCase();
  let normalized = r;
  if(!r || r === 'queued' || r === 'in-que') normalized = 'queued';

  // Determine allowed tabs for this role
  let allowedTabs = [];
  if(normalized === 'admin'){
    allowedTabs = ['home','sports','scoring','matches','live','users'];
  } else if(normalized === 'teacher'){
    allowedTabs = ['home','sports','scoring','matches','live'];
  } else if(normalized === 'user'){
    allowedTabs = ['home','live','matches'];
  } else { // queued or unknown => only home
    allowedTabs = ['home'];
  }

  const nav = document.querySelectorAll('.sidebar nav button[data-tab]');
  nav.forEach(b=>{
    const tab = b.dataset.tab;
    if(allowedTabs.includes(tab)){
      b.classList.remove('disabled');
      b.style.display = 'block';
    } else {
      b.classList.add('disabled');
      b.style.display = 'none';
    }
  });

  // Ensure currently visible tab is allowed; otherwise, fall back to first allowed tab
  const activeSection = document.querySelector('.tab[style*="display:block"]');
  const fallbackTab = allowedTabs[0] || 'home';
  if(!activeSection || !allowedTabs.includes(activeSection.id)){
    showTab(fallbackTab);
  }
}

/* apply role to UI after sign-in */
function applyRoleToUI(role){
  if(!role) role = null;
  localStorage.setItem('go_currentRole', role || '');
  showUserBadge();
  restrictUIForRole(role);
}

/* On page load, restore session if any in localStorage */
(function restoreSession(){
  const email = localStorage.getItem('go_currentEmail');
  const role = localStorage.getItem('go_currentRole');
  const name = localStorage.getItem('go_displayName');
  if(email){
    userNameEl.innerText = name || (email.split('@')[0] || '');
    userEmailEl.innerText = email;
    signedInArea.style.display = 'block';
    signedOutArea.style.display = 'none';
    restrictUIForRole(role || 'queued');
  } else {
    signedInArea.style.display = 'none';
    signedOutArea.style.display = 'block';
    restrictUIForRole(null);
  }
})();

/* Listen to firebase auth state changes (synchronization) */
auth.onAuthStateChanged(async user=>{
  if(user && user.email){
    const email = user.email.toLowerCase();
    // Check registeredUsers - if not present, sign out and show overlay with message
    const doc = await db.collection('registeredUsers').doc(encodeEmailKey(email)).get();
    if(!doc.exists){
      // Place in pending and sign out - user must be approved first
      await addToPending(email);
      await auth.signOut();
      alert('Your account is not yet approved. A request has been placed. Please wait for approval.');
      authOverlay.style.display = 'flex';
      return;
    }
    // user is whitelisted
    const role = doc.data().role || 'user';
    setSessionForUser(email, role, user.displayName || (email.split('@')[0]||''));
    updateSignedInSignedOutUI(true);
    applyRoleToUI(role);
    if(role === 'admin') await loadUsersTab();
  } else {
    // not signed in
    // do nothing here ‚Äî we may have local session via bypass code
  }
});

/* =========================
   Wiring basic tabs and scoring JS (kept from your original file)
   NOTE: For brevity I've included only the essential scoring UI wiring.
   The original file's scoring behavior and RTDB listeners are preserved below.
*/
const SPORTS = ['football','basketball','volleyball','kabaddi','tugofwar','100m','200m','400m','4x100m','zigzag','discus','shotput','javelin','highjump','longjump','badminton_singles','badminton_doubles','tabletennis_singles','tabletennis_doubles','carrom_single','carrom_double','chess','taekwondo','skating'];
const SPORT_LABEL = {
  football:'Football',
  basketball:'Basketball',
  volleyball:'Volleyball',
  kabaddi:'Kabaddi',
  tugofwar:'Tug of War',
  '100m':'100m Race',
  '200m':'200m Race',
  '400m':'400m Race',
  '4x100m':'4x100m Relay',
  zigzag:'Zig Zag Relay',
  discus:'Discus Throw',
  shotput:'Shot Put',
  javelin:'Javelin Throw',
  highjump:'High Jump',
  longjump:'Long Jump',
  badminton_singles:'Badminton Singles',
  badminton_doubles:'Badminton Doubles',
  tabletennis_singles:'Table Tennis Singles',
  tabletennis_doubles:'Table Tennis Doubles',
  carrom_single:'Carrom Single',
  carrom_double:'Carrom Double',
  chess:'Chess',
  taekwondo:'Taekwondo',
  skating:'Skating'
};
const AGES = ['u12','u14','u16','u18'];
const AGE_LABEL = {u12:'U12', u14:'U14', u16:'U16', u18:'U18' };

const tabs = document.querySelectorAll('nav button[data-tab], .bottom-tabs button[data-tab]');
document.querySelectorAll('nav button[data-tab]').forEach(btn=>{
  btn.addEventListener('click',()=>{
    if(btn.classList.contains('disabled')) return;
    document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const t = btn.dataset.tab;
    document.querySelectorAll('.tab').forEach(sec=>sec.style.display='none');
    const s = document.getElementById(t);
    if(s) s.style.display='block';
    // Close mobile sidebar after navigation
    if(window.innerWidth <= 900 && sidebarEl){
      sidebarEl.classList.remove('mobile-open');
    }
  });
});

function showTab(tab){
  const btn = document.querySelector(`nav button[data-tab="${tab}"]`);
  if(btn && !btn.classList.contains('disabled')) btn.click();
}

function populateSportsAndFilters(){
  const mSport = document.getElementById('mSport');
  const mAge = document.getElementById('mAge');
  const sportsGrid = document.getElementById('sportsGrid');
  const filterSportScoring = document.getElementById('filterSportScoring');
  const filterSportMatches = document.getElementById('filterSportMatches');
  const filterSportLive = document.getElementById('filterSportLive');
  const filterAgeScoring = document.getElementById('filterAgeScoring');
  const filterAgeMatches = document.getElementById('filterAgeMatches');
  const filterAgeLive = document.getElementById('filterAgeLive');

  SPORTS.forEach(sp=>{
    const label = SPORT_LABEL[sp] || sp;
    const opt = document.createElement('option'); opt.value=sp; opt.innerText=label;
    if(mSport) mSport.appendChild(opt);

    const tile = document.createElement('div');
    tile.className='card';
    tile.style.cursor='default';
    tile.innerHTML = `<div style="font-weight:900">${label}</div><div class="muted" style="font-size:13px">${sp}</div>`;
    if(sportsGrid) sportsGrid.appendChild(tile);

    const f1 = document.createElement('option'); f1.value=sp; f1.innerText=label;
    if(filterSportScoring) filterSportScoring.appendChild(f1);
    const f2 = f1.cloneNode(true); if(filterSportMatches) filterSportMatches.appendChild(f2);
    const f3 = f1.cloneNode(true); if(filterSportLive) filterSportLive.appendChild(f3);
  });
  AGES.forEach(a=>{
    const opt = document.createElement('option'); opt.value=a; opt.innerText=AGE_LABEL[a] || a;
    if(mAge) mAge.appendChild(opt);

    const fa1 = document.createElement('option'); fa1.value=a; fa1.innerText=AGE_LABEL[a] || a;
    if(filterAgeScoring) filterAgeScoring.appendChild(fa1);
    const fa2 = fa1.cloneNode(true); if(filterAgeMatches) filterAgeMatches.appendChild(fa2);
    const fa3 = fa1.cloneNode(true); if(filterAgeLive) filterAgeLive.appendChild(fa3);
  });
}
populateSportsAndFilters();

/* Keep time label ticking for visual cue */
setInterval(()=>{ const tl = document.getElementById('timeLabel'); if(tl) tl.innerText = new Date().toLocaleTimeString(); }, 1000);

/* Minimal RTDB match list listener (keeps your scoring list updated) */
let lastMatchSnapshot = {};
rtdb.ref('matches').on('value', snap=>{
  lastMatchSnapshot = snap.val() || {};
  renderScoringList(lastMatchSnapshot);
  renderMatchesList(lastMatchSnapshot);
  renderLiveList(lastMatchSnapshot);
});

// Live search for scoring tab
const searchScoringInput = document.getElementById('searchScoring');
if(searchScoringInput){
  searchScoringInput.addEventListener('input', ()=>{
    scoringPage = 1;
    renderScoringList(lastMatchSnapshot);
  });
}

/* Pagination & render helpers */
const PAGE_SIZE = 10;
let scoringPage = 1;
let matchesPage = 1;
let livePage = 1;

function renderPagination(containerId, currentPage, totalItems, onPageChange){
  const container = document.getElementById(containerId);
  if(!container) return;
  const totalPages = Math.max(1, Math.ceil(totalItems / PAGE_SIZE));
  if(totalItems <= PAGE_SIZE){
    container.style.display = 'none';
    container.innerHTML = '';
    return;
  }
  container.style.display = 'flex';
  const maxButtonsToShow = 5;
  let startPage = Math.max(1, currentPage - 2);
  let endPage = Math.min(totalPages, startPage + maxButtonsToShow - 1);
  startPage = Math.max(1, endPage - maxButtonsToShow + 1);

  const buttons = [];
  buttons.push(`<button ${currentPage===1?'disabled':''} data-page="prev">&lt;</button>`);
  for(let p=startPage;p<=endPage;p++){
    buttons.push(`<button data-page="${p}" class="${p===currentPage?'active':''}">${p}</button>`);
  }
  buttons.push(`<button ${currentPage===totalPages?'disabled':''} data-page="next">&gt;</button>`);

  container.innerHTML = buttons.join('');

  container.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const val = btn.getAttribute('data-page');
      if(!val) return;
      let target = currentPage;
      if(val === 'prev' && currentPage>1) target = currentPage-1;
      else if(val === 'next' && currentPage<totalPages) target = currentPage+1;
      else if(val !== 'prev' && val !== 'next') target = parseInt(val,10) || currentPage;
      if(target !== currentPage) onPageChange(target);
    });
  });
}

function makeMatchCard(matchObj, matchId, section){
  const m = matchObj || {};
  const el = document.createElement('div'); el.className='match-card';
  const left = document.createElement('div');

  // Winner / loser summary for finished matches
  let extraLine = '';
  if(m.status === 'finished'){
    // Taekwondo: KO winner overrides points
    if(m.sport === 'taekwondo' && m.koWinner){
      const winnerTeam = m.koWinner === 'A' ? m.teamA : m.teamB;
      const loserTeam  = m.koWinner === 'A' ? m.teamB : m.teamA;
      extraLine = `<div style=\"font-size:13px;margin-top:4px\">
        <span class=\"winner\">Winner: ${winnerTeam} (by KO)</span>
        &nbsp;&nbsp;
        <span class=\"loser\">Loser: ${loserTeam}</span>
      </div>`;
    }
    // Volleyball: use sets summary if available
    else if(m.sport === 'volleyball' && Array.isArray(m.volleyballSets) && m.volleyballSets.length > 0){
      let setsAWon = 0, setsBWon = 0;
      m.volleyballSets.forEach(s=>{
        const a = s.scoreA || 0;
        const b = s.scoreB || 0;
        if(a > b) setsAWon++;
        else if(b > a) setsBWon++;
      });

      if(setsAWon > setsBWon){
        extraLine = `<div style=\"font-size:13px;margin-top:4px\">
          <span class=\"winner\">Winner: ${m.teamA} (${setsAWon}-${setsBWon} sets)</span>
          &nbsp;&nbsp;
          <span class=\"loser\">Loser: ${m.teamB}</span>
        </div>`;
      } else if(setsBWon > setsAWon){
        extraLine = `<div style=\"font-size:13px;margin-top:4px\">
          <span class=\"winner\">Winner: ${m.teamB} (${setsBWon}-${setsAWon} sets)</span>
          &nbsp;&nbsp;
          <span class=\"loser\">Loser: ${m.teamA}</span>
        </div>`;
      } else {
        extraLine = `<div style=\"font-size:13px;margin-top:4px\" class=\"muted\">Match tied (${setsAWon}-${setsBWon} sets)</div>`;
      }
    } else {
      // Default: decide winner by total score (include points)
      const scoreA = m.scoreA || 0;
      const scoreB = m.scoreB || 0;
      if(scoreA > scoreB){
        extraLine = `<div style=\"font-size:13px;margin-top:4px\">
          <span class=\"winner\">Winner: ${m.teamA} (${scoreA}-${scoreB})</span>
          &nbsp;&nbsp;
          <span class=\"loser\">Loser: ${m.teamB}</span>
        </div>`;
      } else if(scoreB > scoreA){
        extraLine = `<div style=\"font-size:13px;margin-top:4px\">
          <span class=\"winner\">Winner: ${m.teamB} (${scoreB}-${scoreA})</span>
          &nbsp;&nbsp;
          <span class=\"loser\">Loser: ${m.teamA}</span>
        </div>`;
      } else {
        // Handle draw / tie (highlighted)
        extraLine = `<div style=\"font-size:13px;margin-top:4px\" class=\"tie\">Match tied (${scoreA}-${scoreB})</div>`;
      }
    }
  }

  // For Matches tab, show final score beside team names (except taekwondo KO)
  let teamsLine = `${m.teamA} vs ${m.teamB}`;
  const hasScore = (m.scoreA != null || m.scoreB != null);
  const isTKOK = (m.sport === 'taekwondo' && m.koWinner);
  if(section === 'matches' && hasScore && !isTKOK){
    const sa = m.scoreA != null ? m.scoreA : 0;
    const sb = m.scoreB != null ? m.scoreB : 0;
    teamsLine += ` ‚Äî ${sa} - ${sb}`;
  }

  left.innerHTML = `<div style=\"font-weight:900\">${SPORT_LABEL[m.sport] || m.sport} ‚Äî ${AGE_LABEL[m.age] || m.age}</div>
                    <div class=\"muted\" style=\"font-size:13px\">${teamsLine}</div>
                    ${extraLine}`;
  const right = document.createElement('div');
  const badge = document.createElement('div'); badge.className='badge';
  if(m.status==='live'){ badge.classList.add('live'); badge.innerText='LIVE'; }
  else if(m.status==='finished'){ badge.classList.add('done'); badge.innerText='FINISHED'; }
  else { badge.classList.add('scheduled'); badge.innerText=(m.round||''); }
  right.appendChild(badge);

  // Scoring tab: keep Open. Matches tab: show Info instead.
  if(section === 'matches'){
    const btnInfo = document.createElement('button'); btnInfo.className='btn'; btnInfo.style.marginLeft='8px'; btnInfo.innerText='Info';
    btnInfo.addEventListener('click', ()=> showMatchInfo(matchId));
    right.appendChild(btnInfo);
  } else {
    const btnOpen = document.createElement('button'); btnOpen.className='btn'; btnOpen.style.marginLeft='8px'; btnOpen.innerText='Open';
    btnOpen.addEventListener('click', ()=> openScoreSheet(matchId));
    right.appendChild(btnOpen);
  }

  el.appendChild(left); el.appendChild(right);
  return el;
}

// Simple info popup for Matches tab (uses overlay)
function showMatchInfo(matchId){
  const m = lastMatchSnapshot[matchId];
  if(!m){ alert('Match not found'); return; }
  if(!matchInfoOverlay || !matchInfoTitle || !matchInfoMeta || !matchInfoContent) return;

  const sportLabel = SPORT_LABEL[m.sport] || m.sport;
  const ageLabel = AGE_LABEL[m.age] || m.age;
  const scoreA = m.scoreA || 0;
  const scoreB = m.scoreB || 0;

  // Title and basic meta
  matchInfoTitle.innerText = `${sportLabel} ‚Äî ${ageLabel}`;
  matchInfoMeta.innerText = `${m.teamA} vs ${m.teamB} ‚Ä¢ ${m.status || ''}`;

  const lines = [];
  lines.push(`<div><strong>Score:</strong> ${scoreA} - ${scoreB}</div>`);
  if(m.referee){
    lines.push(`<div><strong>Referee:</strong> ${escapeHtml(m.referee)}</div>`);
  }

  // Volleyball sets summary, if available
  if(m.sport === 'volleyball' && Array.isArray(m.volleyballSets) && m.volleyballSets.length > 0){
    let setsAWon = 0, setsBWon = 0;
    m.volleyballSets.forEach(s=>{
      const a = s.scoreA || 0;
      const b = s.scoreB || 0;
      if(a > b) setsAWon++;
      else if(b > a) setsBWon++;
    });
    lines.push(`<div><strong>Sets:</strong> ${setsAWon}-${setsBWon} (A-B)</div>`);
  }

  // Sport-agnostic stats like fouls / penalties (if present)
  if(m.stats){
    const foulsA = m.stats.foulsA || 0;
    const foulsB = m.stats.foulsB || 0;
    const pensA  = m.stats.penaltiesA || 0;
    const pensB  = m.stats.penaltiesB || 0;
    if(foulsA || foulsB){
      lines.push(`<div><strong>Fouls:</strong> ${foulsA}-${foulsB} (A-B)</div>`);
    }
    if(pensA || pensB){
      lines.push(`<div><strong>Penalties:</strong> ${pensA}-${pensB} (A-B)</div>`);
    }
  }

  // Event log (e.g., fouls, scores etc.)
  const events = m.events || [];
  if(events.length){
    const items = events.slice(0, 15).map(ev=>`<li>${escapeHtml(ev)}</li>`).join('');
    lines.push(`<div style="margin-top:8px"><strong>Events (latest first):</strong></div>`);
    lines.push(`<ul style="margin:4px 0 0 16px;padding:0;font-size:13px;">${items}</ul>`);
  }

  matchInfoContent.innerHTML = lines.join('');
  matchInfoOverlay.style.display = 'flex';
}

function applyFiltersToMatch(matchObj, section){
  let sportFilter = 'all', ageFilter = 'all';
  if(section==='scoring'){ sportFilter = (document.getElementById('filterSportScoring')||{value:'all'}).value; ageFilter = (document.getElementById('filterAgeScoring')||{value:'all'}).value; }
  if(section==='matches'){ sportFilter = (document.getElementById('filterSportMatches')||{value:'all'}).value; ageFilter = (document.getElementById('filterAgeMatches')||{value:'all'}).value; }
  if(section==='live'){ sportFilter = (document.getElementById('filterSportLive')||{value:'all'}).value; ageFilter = (document.getElementById('filterAgeLive')||{value:'all'}).value; }

  if(sportFilter !== 'all' && matchObj.sport !== sportFilter) return false;
  if(ageFilter !== 'all' && matchObj.age !== ageFilter) return false;

  // Scoring tab search
  if(section==='scoring'){
    const q = (document.getElementById('searchScoring')||{value:''}).value.toLowerCase();
    if(q){
      const hay = `${matchObj.teamA} ${matchObj.teamB} ${matchObj.sport} ${matchObj.age}`.toLowerCase();
      if(!hay.includes(q)) return false;
    }
  }

  // Matches tab filters (view + search)
  if(section==='matches'){
    const viewFilter = window.matchesViewFilter || 'all';
    if(viewFilter==='live' && matchObj.status!=='live') return false;
    if(viewFilter==='finished' && matchObj.status!=='finished') return false;
    const q = (document.getElementById('searchMatches')||{value:''}).value.toLowerCase();
    if(q){
      const hay = `${matchObj.teamA} ${matchObj.teamB} ${matchObj.sport} ${matchObj.age}`.toLowerCase();
      if(!hay.includes(q)) return false;
    }
  }
  if(section==='live' && matchObj.status!=='live') return false;
  return true;
}

function renderScoringList(data){
  const scoringList = document.getElementById('scSchedule');
  if(!scoringList) return;
  scoringList.innerHTML = '';

  // Build filtered & sorted array first
  const allIds = Object.keys(data||{}).sort((a,b)=>{
    const ma = data[a];
    const mb = data[b];
    const rank = m => m.status === 'live' ? 0 : (m.status === 'scheduled' || !m.status ? 1 : 2); // live -> scheduled/other -> finished
    const ra = rank(ma||{});
    const rb = rank(mb||{});
    if(ra !== rb) return ra - rb;
    return (mb.createdAt||0) - (ma.createdAt||0);
  });
  const filteredIds = allIds.filter(id=> applyFiltersToMatch(data[id],'scoring'));
  const total = filteredIds.length;

  if(total === 0){
    scoringList.innerHTML='<div class="muted">No matches</div>';
    renderPagination('scScoringPagination', 1, 0, ()=>{});
    return;
  }

  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  if(scoringPage>totalPages) scoringPage = totalPages;
  const start = (scoringPage-1)*PAGE_SIZE;
  const pageIds = filteredIds.slice(start, start+PAGE_SIZE);

  pageIds.forEach(id=>{
    const m = data[id];
    scoringList.appendChild(makeMatchCard(m,id,'scoring'));
  });

  renderPagination('scScoringPagination', scoringPage, total, (newPage)=>{
    scoringPage = newPage;
    renderScoringList(lastMatchSnapshot);
  });
}

function renderMatchesList(data){
  const matchesList = document.getElementById('matchesList');
  if(!matchesList) return;
  matchesList.innerHTML = '';

  const allIds = Object.keys(data||{}).sort((a,b)=>{
    const ma = data[a];
    const mb = data[b];
    const rank = m => m.status === 'live' ? 0 : (m.status === 'scheduled' || !m.status ? 1 : 2); // live -> scheduled/other -> finished
    const ra = rank(ma||{});
    const rb = rank(mb||{});
    if(ra !== rb) return ra - rb;
    return (mb.createdAt||0) - (ma.createdAt||0);
  });
  const filteredIds = allIds.filter(id=> applyFiltersToMatch(data[id],'matches'));
  const total = filteredIds.length;

  if(total === 0){
    matchesList.innerHTML='<div class="muted">No matches</div>';
    renderPagination('matchesPagination', 1, 0, ()=>{});
    return;
  }

  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  if(matchesPage>totalPages) matchesPage = totalPages;
  const start = (matchesPage-1)*PAGE_SIZE;
  const pageIds = filteredIds.slice(start, start+PAGE_SIZE);

  pageIds.forEach(id=>{
    const m = data[id];
    matchesList.appendChild(makeMatchCard(m,id,'matches'));
  });

  renderPagination('matchesPagination', matchesPage, total, (newPage)=>{
    matchesPage = newPage;
    renderMatchesList(lastMatchSnapshot);
  });
}

function renderLiveList(data){
  const liveList = document.getElementById('liveList');
  if(!liveList) return;
  liveList.innerHTML = '';

  const allIds = Object.keys(data||{}).sort((a,b)=> (data[b].createdAt||0)-(data[a].createdAt||0));
  const filteredIds = allIds.filter(id=> applyFiltersToMatch(data[id],'live'));
  const total = filteredIds.length;

  if(total === 0){
    liveList.innerHTML='<div class="muted">No live matches</div>';
    renderPagination('livePagination', 1, 0, ()=>{});
    return;
  }

  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  if(livePage>totalPages) livePage = totalPages;
  const start = (livePage-1)*PAGE_SIZE;
  const pageIds = filteredIds.slice(start, start+PAGE_SIZE);

  pageIds.forEach(id=>{
    const m = data[id];
    const el = document.createElement('div'); el.className='match-card';
    el.innerHTML = `<div><div style=\"font-weight:900\">${SPORT_LABEL[m.sport]||m.sport}</div><div class=\"muted\" style=\"font-size:13px\">${m.teamA} vs ${m.teamB}</div></div>
                    <div style=\"text-align:right\"><div style=\"font-weight:900;font-size:22px\">${m.scoreA} - ${m.scoreB}</div><div class=\"muted\" style=\"font-size:12px\">${new Date(m.startedAt).toLocaleTimeString()} </div></div>`;
    // Live tab is read-only but allows viewing details via the info overlay
    el.addEventListener('click', ()=> showMatchInfo(id));
    liveList.appendChild(el);
  });

  renderPagination('livePagination', livePage, total, (newPage)=>{
    livePage = newPage;
    renderLiveList(lastMatchSnapshot);
  });
}

/* Score sheet behavior (RTDB) ‚Äî included from original file */
let activeMatchId = null;

/* =========================
   NEW SCORING BUTTON HELPERS
   ========================= */
function createScoreButton(text, side, delta, parentEl){
  const btn = document.createElement('button');
  btn.innerText = text;
  btn.className = 'btn';
  // Pass the button's text as the eventLabel
  btn.addEventListener('click', ()=> applyScore(side, delta, text)); 
  parentEl.appendChild(btn);
}

function createUndoButton(side, parentEl){
  const btn = document.createElement('button');
  btn.innerText = 'Undo';
  btn.className = 'btn';
  btn.addEventListener('click', ()=> undoLast(side));
  parentEl.appendChild(btn);
}

function openScoreSheet(matchId){
  const m = lastMatchSnapshot[matchId];
  if(!m){ alert('Match not found'); return; }

  // If match is finished, confirm before allowing edits
  if(m.status === 'finished'){
    const ok = confirm('This match is already finished. Do you want to edit the points?');
    if(!ok) return;
  }

  activeMatchId = matchId;
  document.getElementById('teamAName').innerText = m.teamA || 'Team A';
  document.getElementById('teamASchool').innerText = m.teamA;
  document.getElementById('teamBName').innerText = m.teamB || 'Team B';
  document.getElementById('teamBSchool').innerText = m.teamB;
  document.getElementById('teamAScore').innerText = m.scoreA||0;
  document.getElementById('teamBScore').innerText = m.scoreB||0;
  document.getElementById('scoreCenter').innerText = `${(m.scoreA||0)} - ${(m.scoreB||0)}`;
  document.getElementById('statusLabel').innerText = (m.status||'').toUpperCase();
  document.getElementById('timeLabel').innerText = new Date(m.startedAt||m.createdAt).toLocaleString();
  document.getElementById('eventLog').innerHTML = (m.events || []).map(ev=>`<div>${ev}</div>`).join('');

  // Referee line
  const refLine = document.getElementById('refereeLine');
  if(refLine){
    if(m.referee){
      refLine.style.display = 'block';
      refLine.textContent = `scored by: ${m.referee}`;
    } else {
      refLine.style.display = 'none';
      refLine.textContent = '';
    }
  }
  
  // === MODIFIED: Add dynamic buttons ===
  const sport = m.sport;
  const teamAControls = document.getElementById('teamAControls');
  const teamBControls = document.getElementById('teamBControls');
  teamAControls.innerHTML = '';
  teamBControls.innerHTML = '';

  // Populate controls based on sport
  switch(sport){
    case 'basketball':
      createScoreButton('+1 (FT)', 'A', 1, teamAControls);
      createScoreButton('+2 (FG)', 'A', 2, teamAControls);
      createScoreButton('+3 (3PT)', 'A', 3, teamAControls);
      createUndoButton('A', teamAControls);

      createScoreButton('+1 (FT)', 'B', 1, teamBControls);
      createScoreButton('+2 (FG)', 'B', 2, teamBControls);
      createScoreButton('+3 (3PT)', 'B', 3, teamBControls);
      createUndoButton('B', teamBControls);
      break;

    case 'kabaddi':
      createScoreButton('+1 Raid', 'A', 1, teamAControls);
      createScoreButton('+1 Bonus', 'A', 1, teamAControls);
      createScoreButton('+1 Tackle', 'A', 1, teamAControls);
      createScoreButton('+2 All-Out', 'A', 2, teamAControls);
      createUndoButton('A', teamAControls);

      createScoreButton('+1 Raid', 'B', 1, teamBControls);
      createScoreButton('+1 Bonus', 'B', 1, teamBControls);
      createScoreButton('+1 Tackle', 'B', 1, teamBControls);
      createScoreButton('+2 All-Out', 'B', 2, teamBControls);
      createUndoButton('B', teamBControls);
      break;

    case 'taekwondo':
      // Taekwondo: keep point scoring AND add KO button
      // Points for Team A
      createScoreButton('+1 Punch', 'A', 1, teamAControls);
      createScoreButton('+1 Penalty', 'A', 1, teamAControls);
      createScoreButton('+2 Kick Torso', 'A', 2, teamAControls);
      createScoreButton('+3 Kick Head', 'A', 3, teamAControls);
      createScoreButton('+4 Spin Torso', 'A', 4, teamAControls);
      createScoreButton('+5 Spin Head', 'A', 5, teamAControls);
      // KO button for Team A
      const koBtnA = document.createElement('button');
      koBtnA.innerText = '+Knockout';
      koBtnA.className = 'btn';
      koBtnA.style.background = '#2ecc71';
      koBtnA.style.color = '#fff';
      koBtnA.style.fontWeight = '800';
      koBtnA.addEventListener('click', ()=> applyKnockout('A'));
      teamAControls.appendChild(koBtnA);
      // Undo for Team A
      createUndoButton('A', teamAControls);

      // Points for Team B
      createScoreButton('+1 Punch', 'B', 1, teamBControls);
      createScoreButton('+1 Penalty', 'B', 1, teamBControls);
      createScoreButton('+2 Kick Torso', 'B', 2, teamBControls);
      createScoreButton('+3 Kick Head', 'B', 3, teamBControls);
      createScoreButton('+4 Spin Torso', 'B', 4, teamBControls);
      createScoreButton('+5 Spin Head', 'B', 5, teamBControls);
      // KO button for Team B
      const koBtnB = document.createElement('button');
      koBtnB.innerText = '+Knockout';
      koBtnB.className = 'btn';
      koBtnB.style.background = '#2ecc71';
      koBtnB.style.color = '#fff';
      koBtnB.style.fontWeight = '800';
      koBtnB.addEventListener('click', ()=> applyKnockout('B'));
      teamBControls.appendChild(koBtnB);
      // Undo for Team B
      createUndoButton('B', teamBControls);
      break;

    case 'carrom_single':
    case 'carrom_double':
      createScoreButton('+1 Coin', 'A', 1, teamAControls);
      createScoreButton('+3 Queen', 'A', 3, teamAControls);
      createUndoButton('A', teamAControls);

      createScoreButton('+1 Coin', 'B', 1, teamBControls);
      createScoreButton('+3 Queen', 'B', 3, teamBControls);
      createUndoButton('B', teamBControls);
      break;

    default:
      // Generic controls
      createScoreButton('+1', 'A', 1, teamAControls);
      createScoreButton('-1', 'A', -1, teamAControls);
      createUndoButton('A', teamAControls);
      
      createScoreButton('+1', 'B', 1, teamBControls);
      createScoreButton('-1', 'B', -1, teamBControls);
      createUndoButton('B', teamBControls);
      break;
  }
  // === END MODIFICATION ===

  // Initialize winner/loser header (if finished)
  renderWinnerLoserHeader(m);
  // Initialize volleyball set UI (if applicable)
  renderVolleyballSets(m);
  
  document.getElementById('scoreSheet').classList.add('show');
}

function updateScoreSheetLive(m){
  document.getElementById('teamAScore').innerText = m.scoreA||0;
  document.getElementById('teamBScore').innerText = m.scoreB||0;
  document.getElementById('scoreCenter').innerText = `${(m.scoreA||0)} - ${(m.scoreB||0)}`;
  document.getElementById('eventLog').innerHTML = (m.events || []).map(ev=>`<div>${ev}</div>`).join('');
  document.getElementById('statusLabel').innerText = (m.status||'').toUpperCase();
  renderWinnerLoserHeader(m);
  // For volleyball, also refresh set summary UI
  if(m.sport === 'volleyball'){
    renderVolleyballSets(m);
  } else {
    const area = document.getElementById('volleyballSetsArea');
    if(area) area.style.display = 'none';
  }
}

// Show winner/loser line in the score sheet header for finished matches
function renderWinnerLoserHeader(match){
  const el = document.getElementById('winnerLoserHeader');
  if(!el || !match) return;

  if(match.status !== 'finished'){
    el.innerHTML = '';
    return;
  }

  // Taekwondo KO overrides everything
  if(match.sport === 'taekwondo' && match.koWinner){
    const winnerTeam = match.koWinner === 'A' ? match.teamA : match.teamB;
    const loserTeam  = match.koWinner === 'A' ? match.teamB : match.teamA;
    el.innerHTML = `<span class=\"winner\">Winner: ${winnerTeam} (by KO)</span>
                    &nbsp;&nbsp;
                    <span class=\"loser\">Loser: ${loserTeam}</span>`;
    return;
  }

  // Special handling for volleyball: use sets won if available
  if(match.sport === 'volleyball'){
    const sets = match.volleyballSets || [];
    if(sets.length > 0){
      let setsAWon = 0, setsBWon = 0;

      // Count completed sets
      sets.forEach(s=>{
        const a = s.scoreA || 0;
        const b = s.scoreB || 0;
        if(a > b) setsAWon++;
        else if(b > a) setsBWon++;
      });

      if(setsAWon > setsBWon){
        el.innerHTML = `<span class="winner">Winner: ${match.teamA} (${setsAWon}-${setsBWon} sets)</span>
                        &nbsp;&nbsp;
                        <span class="loser">Loser: ${match.teamB}</span>`;
      } else if(setsBWon > setsAWon){
        el.innerHTML = `<span class="winner">Winner: ${match.teamB} (${setsBWon}-${setsAWon} sets)</span>
                        &nbsp;&nbsp;
                        <span class="loser">Loser: ${match.teamA}</span>`;
      } else {
        // Fallback: tied in sets, show as tied
        el.innerHTML = `<span class="muted">Match tied (${setsAWon}-${setsBWon} sets)</span>`;
      }
      return;
    }
    // If no sets data, fall through and use point totals
  }

  // Default (non-volleyball): use total score (include points)
  const scoreA = match.scoreA || 0;
  const scoreB = match.scoreB || 0;

  if(scoreA > scoreB){
    el.innerHTML = `<span class=\"winner\">Winner: ${match.teamA} (${scoreA}-${scoreB})</span>
                    &nbsp;&nbsp;
                    <span class=\"loser\">Loser: ${match.teamB}</span>`;
  } else if(scoreB > scoreA){
    el.innerHTML = `<span class=\"winner\">Winner: ${match.teamB} (${scoreB}-${scoreA})</span>
                    &nbsp;&nbsp;
                    <span class=\"loser\">Loser: ${match.teamA}</span>`;
  } else {
    el.innerHTML = `<span class=\"muted\">Match tied (${scoreA}-${scoreB})</span>`;
  }
}

// Render per-set summary for volleyball matches
function renderVolleyballSets(match){
  const area = document.getElementById('volleyballSetsArea');
  const list = document.getElementById('volleyballSetsList');
  const label = document.getElementById('currentSetLabel');
  const btn = document.getElementById('btnNextSet');
  if(!area || !list || !label || !btn) return;

  if(match.sport !== 'volleyball'){
    area.style.display = 'none';
    return;
  }

  area.style.display = 'block';
  const sets = match.volleyballSets || [];

  if(sets.length === 0){
    list.innerHTML = '<div class="muted">No completed sets yet</div>';
  } else {
    list.innerHTML = sets.map(s=>`<div>Set ${s.set}: ${s.scoreA} - ${s.scoreB}</div>`).join('');
  }

  const currentSetNumber = match.currentSetNumber || (sets.length + 1);
  label.innerText = `Current set: ${currentSetNumber}`;
}

// Move to the next set for volleyball without ending the match
function advanceVolleyballSet(){
  if(!activeMatchId) return;
  const ref = rtdb.ref(`matches/${activeMatchId}`);
  ref.transaction(match=>{
    if(!match || match.sport !== 'volleyball') return match;

    const sets = match.volleyballSets || [];
    const currentSetNumber = match.currentSetNumber || (sets.length + 1);
    const scoreA = match.scoreA || 0;
    const scoreB = match.scoreB || 0;

    // Save the just-finished set
    sets.push({ set: currentSetNumber, scoreA, scoreB });
    match.volleyballSets = sets;
    match.currentSetNumber = currentSetNumber + 1;
    
    match.events = match.events || [];
    match.events.unshift(`${(new Date()).toLocaleTimeString()} ‚Äî End of set ${currentSetNumber}: ${scoreA} - ${scoreB}`);

    // Reset scores for the new set
    match.scoreA = 0;
    match.scoreB = 0;
    match.updatedAt = Date.now();
    return match;
  }, function(err, committed, snapshot){
    if(err){ console.error('advanceVolleyballSet failed', err); return; }
    if(committed && snapshot.val() && activeMatchId === snapshot.key){
      updateScoreSheetLive(snapshot.val());
    }
  });
}

// Wire the Next Set button once
const btnNextSetEl = document.getElementById('btnNextSet');
if(btnNextSetEl) btnNextSetEl.addEventListener('click', advanceVolleyballSet);

// Collapsible event log in score sheet
const eventLogWrapperEl = document.getElementById('eventLogWrapper');
const toggleEventLogBtn = document.getElementById('toggleEventLog');
if(eventLogWrapperEl && toggleEventLogBtn){
  toggleEventLogBtn.addEventListener('click', ()=>{
    const isHidden = !eventLogWrapperEl.style.display || eventLogWrapperEl.style.display === 'none';
    eventLogWrapperEl.style.display = isHidden ? 'block' : 'none';
    toggleEventLogBtn.textContent = isHidden ? 'Hide events' : 'Show events';
  });
}

// Taekwondo KO handler
function applyKnockout(side){
  if(!activeMatchId) return;
  const ref = rtdb.ref(`matches/${activeMatchId}`);
  ref.transaction(match=>{
    if(!match) return match;
    if(match.sport !== 'taekwondo') return match;
    // Do not override if KO already recorded
    if(match.koWinner) return match;

    match.koWinner = side;
    match.status = 'finished';
    const now = Date.now();
    match.finishedAt = now;
    match.updatedAt = now;

    const winnerTeam = side === 'A' ? (match.teamA || 'Team A') : (match.teamB || 'Team B');
    match.events = match.events || [];
    // include Team A/Team B so undoLast can find it
    const sideLabel = side === 'A' ? 'Team A' : 'Team B';
    match.events.unshift(`${(new Date()).toLocaleTimeString()} ‚Äî ${sideLabel} Knockout: ${winnerTeam}`);
    return match;
  }, function(err, committed, snapshot){
    if(err){ console.error('applyKnockout failed', err); return; }
    if(committed && snapshot.val() && activeMatchId === snapshot.key){
      updateScoreSheetLive(snapshot.val());
    }
  });
}

document.getElementById('closeScore').addEventListener('click', ()=> {
  document.getElementById('scoreSheet').classList.remove('show');
  activeMatchId = null;
});

function pushEventToMatch(matchId, text){
  const t = `${(new Date()).toLocaleTimeString()} ‚Äî ${text}`;
  rtdb.ref(`matches/${matchId}`).transaction(match=>{
    if(!match) return match;
    match.events = match.events || [];
    match.events.unshift(t);
    match.updatedAt = Date.now();
    return match;
  });
  return t;
}

// === MODIFIED: Added eventLabel parameter ===
function applyScore(side, delta, eventLabel){
  if(!activeMatchId) return;
  const ref = rtdb.ref(`matches/${activeMatchId}`);
  ref.transaction(match=>{
    if(!match) return match;

    // Update score
    if(side==='A'){ match.scoreA = Math.max(0, (match.scoreA||0) + delta); }
    else { match.scoreB = Math.max(0, (match.scoreB||0) + delta); }
    
    // Track non-point stats like fouls/penalties separately per side
    if(eventLabel){
      const labelLower = eventLabel.toLowerCase();
      match.stats = match.stats || {};
      const isSideA = (side === 'A');
      // Generic foul counter
      if(labelLower.includes('foul')){
        const key = isSideA ? 'foulsA' : 'foulsB';
        match.stats[key] = (match.stats[key] || 0) + 1;
      }
      // Generic penalty counter
      if(labelLower.includes('penalty')){
        const key = isSideA ? 'penaltiesA' : 'penaltiesB';
        match.stats[key] = (match.stats[key] || 0) + 1;
      }
    }

    // --- MODIFIED: Use eventLabel for log ---
    let txt = '';
    const teamName = side==='A' ? 'Team A' : 'Team B';
    if(eventLabel){
      // Use the custom label (e.g., "+3 (3PT)")
      txt = `${teamName} ${eventLabel}`;
    } else {
      // Fallback for generic
      txt = `${teamName} ${delta>0?'+':'-'}${Math.abs(delta)}`;
    }
    // --- END MOD ---

    match.events = match.events || [];
    match.events.unshift(`${(new Date()).toLocaleTimeString()}  ${txt}`);
    match.updatedAt = Date.now();
    return match;
  }, function(err, committed, snapshot){
    if(err){ console.error('Transaction failed', err); return; }
    if(committed){
      const m = snapshot.val();
      if(activeMatchId === snapshot.key){
        updateScoreSheetLive(m);
      }
    }
  });
}

// === MODIFIED: Removed static button listeners ===
// document.getElementById('incA').addEventListener('click', ()=> applyScore('A', 1));
// document.getElementById('decA').addEventListener('click', ()=> applyScore('A', -1));
// document.getElementById('incB').addEventListener('click', ()=> applyScore('B', 1));
// document.getElementById('decB').addEventListener('click', ()=> applyScore('B', -1));
// document.getElementById('undoA').addEventListener('click', ()=> undoLast('A'));
// document.getElementById('undoB').addEventListener('click', ()=> undoLast('B'));

function undoLast(side){
  if(!activeMatchId) return;
  const ref = rtdb.ref(`matches/${activeMatchId}`);
  ref.transaction(match=>{
    if(!match || !match.events || match.events.length===0) return match;
    let idx = -1;
    for(let i=0;i<match.events.length;i++){
      const ev = match.events[i];
      if(side==='A' && ev.includes('Team A')){ idx=i; break; }
      if(side==='B' && ev.includes('Team B')){ idx=i; break; }
    }
    if(idx===-1) return match;
    const ev = match.events.splice(idx,1)[0];

    // Special case: undo taekwondo KO
    if(match.sport === 'taekwondo' && ev.includes('Knockout')){
      // Clear KO winner and revert to live (scores unchanged)
      match.koWinner = null;
      match.status = 'live';
      match.finishedAt = null;
      match.events.unshift(`${(new Date()).toLocaleTimeString()} ‚Äî UNDO KO ${side}`);
      match.updatedAt = Date.now();
      return match;
    }
    
    // Try to find score from label like (+X) or +X
    const m = ev.match(/\([+-]?(\d+)\)/) || ev.match(/[+-](\d+)/);
    let delta = 0;
    if(m){ 
      delta = parseInt(m[1],10); 
      if(ev.includes('-')) delta = -delta; 
    }
    
    if(side==='A'){ match.scoreA = Math.max(0, (match.scoreA||0) - delta); }
    else { match.scoreB = Math.max(0, (match.scoreB||0) - delta); }
    match.events.unshift(`${(new Date()).toLocaleTimeString()} ‚Äî UNDO ${side}`);
    match.updatedAt = Date.now();
    return match;
  }, function(err, committed, snapshot){
    if(err) console.error('Undo failed', err);
    if(committed && snapshot.val() && activeMatchId === snapshot.key) updateScoreSheetLive(snapshot.val());
  });
}

document.getElementById('finishMatch').addEventListener('click', async ()=>{
  if(!activeMatchId) return;
  if(!confirm('Mark match as finished?')) return;

  const ref = rtdb.ref(`matches/${activeMatchId}`);
  const now = Date.now();

  ref.transaction(match=>{
    if(!match) return match;

    // For volleyball, make sure the final set is recorded in volleyballSets
    if(match.sport === 'volleyball'){
      const sets = match.volleyballSets || [];
      const scoreA = match.scoreA || 0;
      const scoreB = match.scoreB || 0;
      const currentSetNumber = match.currentSetNumber || (sets.length + 1);

      // Only push if there is a non-zero score and we haven't just started a fresh set
      if(scoreA > 0 || scoreB > 0){
        sets.push({ set: currentSetNumber, scoreA, scoreB });
        match.volleyballSets = sets;
        match.events = match.events || [];
        match.events.unshift(`${(new Date()).toLocaleTimeString()} ‚Äî End of set ${currentSetNumber}: ${scoreA} - ${scoreB}`);
      }
    }

    match.status = 'finished';
    match.finishedAt = now;
    match.updatedAt = now;
    return match;
  }, function(err, committed, snapshot){
    if(err){ console.error('finishMatch transaction failed', err); return; }
    if(committed){
      document.getElementById('statusLabel').innerText = 'FINISHED';
      document.getElementById('scoreSheet').classList.remove('show');
      activeMatchId = null;
    }
  });
});

document.getElementById('resetMatch').addEventListener('click', async ()=>{
  if(!activeMatchId) return;
  if(!confirm('Reset scores to 0 and clear events?')) return;

  const ref = rtdb.ref(`matches/${activeMatchId}`);
  await ref.transaction(match=>{
    if(!match) return match;
    match.scoreA = 0;
    match.scoreB = 0;
    match.events = [];
    // If it was a taekwondo KO, clear KO state and make match live again
    if(match.sport === 'taekwondo'){
      match.koWinner = null;
      match.status = 'live';
      match.finishedAt = null;
    }
    match.updatedAt = Date.now();
    return match;
  });

  document.getElementById('teamAScore').innerText='0';
  document.getElementById('teamBScore').innerText='0';
  document.getElementById('eventLog').innerHTML='';
  pushEventToMatch(activeMatchId, 'Match reset');
});

/* filters */
window.matchesViewFilter = 'all';
const filterAllBtn = document.getElementById('filterAll');
const filterLiveBtn = document.getElementById('filterLive');
const filterFinishedBtn = document.getElementById('filterFinished');

function setMatchesFilter(mode){
  window.matchesViewFilter = mode;
  // Update visual state
  [filterAllBtn, filterLiveBtn, filterFinishedBtn].forEach(btn=>{
    if(btn) btn.classList.remove('match-filter-active');
  });
  if(mode === 'all' && filterAllBtn) filterAllBtn.classList.add('match-filter-active');
  if(mode === 'live' && filterLiveBtn) filterLiveBtn.classList.add('match-filter-active');
  if(mode === 'finished' && filterFinishedBtn) filterFinishedBtn.classList.add('match-filter-active');
  renderMatchesList(lastMatchSnapshot);
}

if(filterAllBtn) filterAllBtn.addEventListener('click', ()=> setMatchesFilter('all'));
if(filterLiveBtn) filterLiveBtn.addEventListener('click', ()=> setMatchesFilter('live'));
if(filterFinishedBtn) filterFinishedBtn.addEventListener('click', ()=> setMatchesFilter('finished'));

// Initialize default state
setMatchesFilter('all');
document.getElementById('searchMatches').addEventListener('input', ()=> renderMatchesList(lastMatchSnapshot));
['filterSportScoring','filterAgeScoring','filterSportMatches','filterAgeMatches','filterSportLive','filterAgeLive'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('change', ()=> { renderScoringList(lastMatchSnapshot); renderMatchesList(lastMatchSnapshot); renderLiveList(lastMatchSnapshot); });
});

/* Minimal start scoring button handlers */
document.getElementById('btnStartScoring').addEventListener('click', ()=> document.getElementById('startModal').classList.add('show'));
document.getElementById('startCancel').addEventListener('click', ()=> document.getElementById('startModal').classList.remove('show'));
document.getElementById('startCreate').addEventListener('click', async ()=>{
  const sport = (document.getElementById('mSport')||{value:''}).value;
  const age = (document.getElementById('mAge')||{value:''}).value;
  const teamA = ((document.getElementById('mTeamA')||{value:''}).value||'Team A').trim();
  const teamB = ((document.getElementById('mTeamB')||{value:''}).value||'Team B').trim();
  const referee = (getSessionEmail() || '').trim();
  if(!sport || !age || !teamA || !teamB){ alert('Fill all fields'); return; }
  const matchRef = rtdb.ref('matches').push();
  const matchId = matchRef.key;
  const now = Date.now();
  const doc = {
    sport, age, teamA, teamB,
    referee: referee || null,
    scoreA:0, scoreB:0, status:'live', events:[], createdAt: now, startedAt: now, finishedAt: null, updatedAt: now
  };

  // Initialize volleyball-specific fields so we can track multiple sets
  if(sport === 'volleyball'){
    doc.volleyballSets = [];
    doc.currentSetNumber = 1;
  }

  try{
    await matchRef.set(doc);
    document.getElementById('startModal').classList.remove('show');
    openScoreSheet(matchId);
  }catch(e){ alert('Failed to create match: '+e.message); }
});

/* =========================
   Quick helpers on load
*/
(function init(){
  // simple default UI
  setTimeout(()=>{ if(!auth.currentUser && !localStorage.getItem('go_currentEmail')) authOverlay.style.display='flex'; }, 600);
})();
</script>
</body>
</html>
